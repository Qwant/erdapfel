{"version":3,"sources":["webpack:///./src/adapters/pois_styles.ts","webpack:///./local_modules/mapbox_style_configure/index.js","webpack:///./src/mapbox/locale.ts","webpack:///./src/components/PoiPopup.jsx","webpack:///./src/adapters/poi_popup.js","webpack:///./src/mapbox/mobile_compass_control.js","webpack:///./src/mapbox/extended_scale_control.js","webpack:///./src/mapbox/extended_attribution_control.js","webpack:///./src/libs/renderStaticReact.js","webpack:///./src/mapbox/extended_geolocate_control.js","webpack:///./src/mapbox/extended_nav_control.js","webpack:///./src/adapters/poi/map_poi.js","webpack:///./src/adapters/scene_config.js","webpack:///./src/panel/direction/RouteLabel/index.jsx","webpack:///./src/adapters/route_styles.js","webpack:///./src/adapters/scene_direction.js","webpack:///./src/adapters/scene_category.js","webpack:///./src/adapters/scene.js"],"names":["module","exports","configure","style","mapStyleConfig","lang","JSON","parse","replace","baseMapUrl","poiMapUrl","spritesUrl","fontsUrl","PoiPopup","poi","useFavorites","isInFavorites","removeFromFavorites","addToFavorites","isDirectionActive","useConfig","enabled","openDirection","Telemetry","sendPoiEvent","window","app","navigateTo","onClickPhoneNumber","source","meta","buildInteractionData","id","template","zone","element","toggleStorePoi","e","preventDefault","isFavorite","stored","fire","WAIT_BEFORE_DISPLAY","WAIT_BEFORE_CLOSE","undefined","prototype","init","map","popupHandle","timeOutHandler","activePoiId","closeTimeoutHandler","listen","isMobileDevice","isTouchEvent","createPJPopup","close","clearTimeout","setTimeout","addListener","layer","on","features","properties","global_id","createOSMPopup","originalEvent","layerPoi","event","ApiPoi","poiApiLoad","simple","showPopup","popupOptions","className","closeButton","maxWidth","offset","anchor","getPopupAnchor","Popup","setLngLat","latLon","setHTML","addTo","popupWrapper","document","querySelector","ReactDOM","render","VERTICAL_OFFSET","HORIZONTAL_OFFSET","canvasWidth","innerWidth","anchorFragments","clientY","push","clientX","join","unmountComponentAtNode","remove","sourceCapabilities","firesTouchEvents","MobileCompassControl","_container","createElement","compassClass","_compass","_createButton","_resetNorthAndTilt","compassIndicatorClass","_compassIndicator","_createIcon","appendChild","_map","textContent","_pitchAndRotateCompassArrow","bind","parentNode","removeChild","navigator","geolocation","getCurrentPosition","position","flyTo","center","coords","longitude","latitude","maximumAge","ariaLabel","fn","a","setAttribute","addEventListener","easeTo","pitch","bearing","getPitch","transform","angle","classList","add","scale","rotation","Math","PI","ExtendedScaleControl","options","container","parentContainer","_onMove","ScaleControl","ExtendedAttributionControl","AttributionControl","reactElement","ReactDOMServer","renderToStaticMarkup","ExtendedGeolocateControl","addOnce","LOCALISE_TRIGGER","_setupUI","cb","_onReady","Geolocation","state","PROMPT","store","openPendingGeolocateModal","supported","_geolocateButton","firstChild","innerHTML","renderStaticReact","error","disabled","GeolocateControl","ExtendedControl","topButtonGroup","bottomButtonGroup","directionShortcutCallback","_zoomInButton","MAP_ZOOM_IN","zoomIn","_zoomOutButton","MAP_ZOOM_OUT","zoomOut","_direction","MAP_ITINERARY","geolocControl","GeolocControl","positionOptions","enableHighAccuracy","trackUserLocation","showAccuracyCircle","onReady","addControl","scaleAttributionContainer","extendedScaleControl","unit","extendedAttributionControl","unListen","MapPoi","feature","subClassName","subclass","name","ll","LngLat","convert","geometry","coordinates","POI_TYPE","Poi","nconf","get","mapStyle","baseUrl","system","sceneConfig","Object","assign","URI","toAbsoluteUrl","location","origin","getStyle","stringify","qwantStyle","getBaseLang","code","VEHICLES","TRAIN","SUBWAY","SUBURBAN_TRAIN","BUS_CITY","TRAM","PublicTransportIcon","mode","PublicTransportStepIcons","route","nonWalkLegs","legs","filter","leg","length","index","RouteLabel","vehicle","isPublicTransport","formatDuration","duration","formatDistance","distance","darkenColor","hex","Color","mix","safeHexColor","charAt","prepareRouteColor","lineColor","outlineColor","getColorExpression","isActive","isOutline","getRouteStyle","type","layout","visibility","paint","setActiveRouteStyle","layerId","setLayoutProperty","setPaintProperty","createMarker","lngLat","Marker","createRouteLabel","onclick","getLabelsBbbox","labelPositions","routesBbox","smallScreen","shift","latShift","getNorth","getSouth","lngShift","getEast","getWest","labelsBbbox","LngLatBounds","shiftLabelPosition","forEach","labelPosition","extend","lng","lat","SceneDirection","originMarker","draggable","refreshDirection","target","getLngLat","routeMarkers","destinationMarker","routes","routeLabels","fullBbox","mapFeaturesByRoute","iconsBaseUrl","addMapImage","pixelRatio","activeRouteId","reset","displayRoutes","routeId","fitView","setMainRoute","step","computeBBox","highlightStep","unhighlightStep","setOrigin","setDestination","getAllSteps","idx","stepMarker","maneuver","getElement","getAllStops","stop","stopMarker","title","mainRoute","outlineLayerId","moveLayer","routes_layer","updateMarkers","updateRouteLabels","marker","addMarkerSteps","originDestinationCoords","destination","addRouteFeatures","getLabelPositions","querySelectorAll","routeLabel","dataset","toString","newPoint","LatLonPoi","sourceId","removeLayer","removeSource","concat","featureCollection","normalizeToFeatureCollection","sources","walkFeatures","nonWalkFeatures","data","getDataSources","addSource","layerStyle","outlineLayerStyle","addLayer","getCanvas","cursor","bbox","minX","minY","maxX","maxY","url","loadImage","image","Error","sendOnce","addImage","poisToGeoJSON","pois","poiFeature","poiToGeoJSON","iconName","IconManager","iconClass","SceneCategory","hoveredPoi","hoveredMarker","createPinIcon","disablePointerEvents","selectedPoi","selectedMarker","createMapGLIcon","then","imageData","sourceName","emptyFeatureCollection","promoteId","showNamesWithPins","labelLayerId","getFilteredPoisLabelStyle","layers","pinLayerId","getFilteredPoisPinStyle","layerName","handleLayerMarkerClick","handleLayerMarkerMouseOver","handleLayerMarkerMouseLeave","mapMouseEvent","find","p","poiFilters","category","toUrl","centerMap","selectPoiMarker","stopPropagation","getPointedPoi","selectPoi","highlightPoiMarker","setOsmPoisVisibility","getSource","setData","displayed","constants","pois_layers","setFeatureState","highlight","setPoiFeatureState","hovered","selected","initActiveStateMarkers","initDynamicPoiLayers","addCategoryMarkers","removeCategoryMarkers","LONG_TOUCH_DELAY_MS","MOBILE_IDLE_DELAY_MS","MOBILE_IDLE_TIMEOUT","Scene","currentMarker","popup","savedLocation","getPoiView","zoom","getBestZoom","bounds","hideMobileScale","item","showMobileScale","getMapInitOptions","locationHash","parseBboxString","console","hotLoadPoi","lastLocation","getLastLocation","initialBbox","fitBoundsOptions","maxZoom","mapConfig","initMapBox","times","Date","now","compilationHash","__config","setRTLTextPlugin","send","mb","Map","attributionControl","hash","locale","setPadding","getCurrentMapPaddings","interactiveLayers","DOUBLE_TAP_DELAY_MS","lastDoubleTapTimeStamp","lastTouchEndTimeStamp","timeStamp","onHashChange","interactiveLayer","setPoiHoverStyle","hover","clickDelayHandler","cancelBubble","detail","queryRenderedFeatures","point","clickOnMap","longTouchTimeout","touches","longTouch","cancelClickAfterLongTouch","longTouchCancellingEvents","cancelLongTouch","getCenter","getZoom","setLastLocation","updateHash","getLocationHash","execOnMapLoaded","f","forceAnimate","fitMap","ensureMarkerIsVisible","addMarker","cleanMarker","saveLocation","restoreLocation","bottom","moveMobileBottomUI","moveMobileGeolocationButton","visible","mobileButtonVisibility","clickedFeature","parseMapHash","flyOptions","animate","screenSpeed","clamp","min","max","value","isBBoxInExtendedViewport","viewport","getBounds","width","height","setNorthEast","wrap","setSouthWest","contains","getNorthWest","getNorthEast","getSouthEast","getSouthWest","fitBbox","Array","fitBounds","isArray","isWindowedPoi","isMobile","isPoiUnderPanel","isPositionUnderUI","project","maxDuration","createDefaultPin","getMapHash","restoreFromHash","zll","onhashchange","translateUIControl","selector","uiControls","uiControl"],"mappings":"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","file":"map-c7bd79da7bd4aaa22661.bundle.js","sourcesContent":["\"use strict\";\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.setPoiHoverStyle = exports.getFilteredPoisLabelStyle = exports.getFilteredPoisPinStyle = void 0;\nvar colors_1 = require(\"src/libs/colors\");\nvar getFilteredPoisPinStyle = function () { return ({\n    type: 'symbol',\n    layout: {\n        'icon-image': ['concat', 'pin-', ['get', 'iconName']],\n        'icon-allow-overlap': true,\n        'icon-ignore-placement': false,\n        'icon-padding': 0,\n        'icon-anchor': 'bottom',\n    },\n    paint: {\n        'icon-opacity': [\n            'case',\n            ['==', ['feature-state', 'selected'], true],\n            0,\n            ['==', ['feature-state', 'hovered'], true],\n            0,\n            1,\n        ],\n    },\n}); };\nexports.getFilteredPoisPinStyle = getFilteredPoisPinStyle;\nvar getFilteredPoisLabelStyle = function () { return ({\n    type: 'symbol',\n    layout: {\n        'text-font': ['Noto Sans Bold'],\n        'text-size': 10,\n        'text-field': ['get', 'name'],\n        'text-allow-overlap': false,\n        'text-ignore-placement': false,\n        'text-optional': true,\n        'text-variable-anchor': ['top', 'bottom-left', 'bottom-right'],\n        'text-offset': [1.5, 0.5],\n        'text-justify': 'auto',\n    },\n    paint: {\n        'text-color': ['case', ['==', ['feature-state', 'selected'], true], colors_1.RED_DARKER, colors_1.GREY_BLACK],\n        'text-halo-color': 'white',\n        'text-halo-width': 1,\n        'text-translate': [0, -2],\n    },\n}); };\nexports.getFilteredPoisLabelStyle = getFilteredPoisLabelStyle;\nvar setPoiHoverStyle = function (map, poiLayer) {\n    if (!map.getPaintProperty) {\n        // @MAPBOX: This method isn't implemented by the Mapbox-GL mock\n        return;\n    }\n    var textColorProperty = map.getPaintProperty(poiLayer, 'text-color');\n    map.setPaintProperty(poiLayer, 'text-color', ['case', ['to-boolean', ['feature-state', 'hover']], colors_1.ACTION_BLUE_BASE, textColorProperty], { validate: false });\n};\nexports.setPoiHoverStyle = setPoiHoverStyle;\n","module.exports = function configure(style, mapStyleConfig, lang) {\n  return JSON.parse(style\n    .replace(/\\{locale\\}/g, lang)\n    .replace('\"{tileserver_base}\"', mapStyleConfig.baseMapUrl)\n    .replace('\"{tileserver_poi}\"', mapStyleConfig.poiMapUrl)\n    .replace('{spriteserver}', mapStyleConfig.spritesUrl)\n    .replace('{fontserver}', mapStyleConfig.fontsUrl)\n  )\n}\n","\"use strict\";\n/* global _ */\nObject.defineProperty(exports, \"__esModule\", { value: true });\nvar defaultLocale = {\n    'GeolocateControl.FindMyLocation': _('My location', 'mapbox'),\n};\nexports.default = defaultLocale;\n","import React from 'react';\nimport PoiItem from './PoiItem';\nimport { fire } from 'src/libs/customEvents';\nimport ActionButtons from '../panel/poi/ActionButtons';\nimport Telemetry from '../libs/telemetry';\nimport { useConfig, useFavorites } from '../hooks';\n\nconst PoiPopup = ({ poi }) => {\n  const { isInFavorites, removeFromFavorites, addToFavorites } = useFavorites();\n  const isDirectionActive = useConfig('direction').enabled;\n\n  const openDirection = () => {\n    Telemetry.sendPoiEvent(poi, 'itinerary');\n    window.app.navigateTo('/routes/', { poi });\n  };\n\n  const onClickPhoneNumber = () => {\n    const source = poi.meta && poi.meta.source;\n    if (source) {\n      Telemetry.sendPoiEvent(\n        poi,\n        'phone',\n        Telemetry.buildInteractionData({\n          id: poi.id,\n          source,\n          template: 'single',\n          zone: 'detail',\n          element: 'phone',\n        })\n      );\n    }\n  };\n\n  const toggleStorePoi = e => {\n    e?.preventDefault();\n    const isFavorite = isInFavorites(poi);\n    Telemetry.sendPoiEvent(poi, 'favorite', { stored: !isFavorite });\n    if (isFavorite) {\n      removeFromFavorites(poi);\n    } else {\n      addToFavorites(poi);\n    }\n  };\n\n  return (\n    <div\n      className=\"poi_popup\"\n      onMouseEnter={() => {\n        fire('stop_close_popup_timeout');\n      }}\n      onMouseLeave={() => {\n        fire('close_popup');\n      }}\n    >\n      <div className=\"u-mb-s\">\n        <PoiItem poi={poi} withOpeningHours withImage inList />\n      </div>\n      <ActionButtons\n        poi={poi}\n        isDirectionActive={isDirectionActive}\n        openDirection={openDirection}\n        onClickPhoneNumber={onClickPhoneNumber}\n        isPoiInFavorite={isInFavorites(poi)}\n        toggleStorePoi={toggleStorePoi}\n      />\n    </div>\n  );\n};\n\nexport default PoiPopup;\n","import React from 'react';\nimport ReactDOM from 'react-dom';\nimport { Popup } from 'mapbox-gl--ENV';\nimport ApiPoi from './poi/idunn_poi';\nimport { isMobileDevice } from 'src/libs/device';\nimport ReactPoiPopup from 'src/components/PoiPopup';\nimport { fire, listen } from 'src/libs/customEvents';\n\nconst WAIT_BEFORE_DISPLAY = 350;\nconst WAIT_BEFORE_CLOSE = 350;\n\nfunction PoiPopup() {\n  return undefined;\n}\n\nPoiPopup.prototype.init = function (map) {\n  this.map = map;\n  this.popupHandle = null;\n  this.timeOutHandler = null;\n  this.activePoiId = null;\n  this.closeTimeoutHandler = null;\n\n  listen('open_popup', (poi, e) => {\n    if (isMobileDevice() || isTouchEvent(e)) {\n      return;\n    }\n    this.createPJPopup(poi, e);\n    fire('stop_close_popup_timeout');\n  });\n  listen('close_popup', () => this.close());\n  listen('clean_marker', () => {\n    this.close();\n    this.activePoiId = null;\n  });\n\n  listen('stop_close_popup_timeout', () => clearTimeout(this.closeTimeoutHandler));\n  listen('start_close_popup_timeout', () => {\n    clearTimeout(this.closeTimeoutHandler);\n    this.closeTimeoutHandler = setTimeout(() => {\n      fire('close_popup');\n    }, WAIT_BEFORE_CLOSE);\n  });\n};\n\nPoiPopup.prototype.addListener = function (layer) {\n  this.map.on('mouseenter', layer, e => {\n    if (isMobileDevice() || isTouchEvent(e)) {\n      return;\n    }\n    this.timeOutHandler = setTimeout(() => {\n      const poi = e.features[0];\n      if (this.activePoiId === poi.properties.global_id) {\n        return;\n      }\n      this.createOSMPopup(poi, e.originalEvent);\n    }, WAIT_BEFORE_DISPLAY);\n  });\n\n  this.map.on('click', () => {\n    this.close();\n  });\n\n  this.map.on('mouseleave', layer, async () => {\n    clearTimeout(this.timeOutHandler);\n    fire('start_close_popup_timeout');\n  });\n};\n\nPoiPopup.prototype.createOSMPopup = async function (layerPoi, event) {\n  const poi = await ApiPoi.poiApiLoad({ id: layerPoi.properties.global_id }, { simple: true });\n  if (poi) {\n    this.showPopup(poi, event);\n  }\n};\n\nPoiPopup.prototype.createPJPopup = function (poi, event) {\n  if (poi) {\n    this.showPopup(poi, event);\n  }\n};\n\nPoiPopup.prototype.showPopup = function (poi, event) {\n  this.close();\n\n  const popupOptions = {\n    className: 'poi_popup__container',\n    closeButton: false,\n    maxWidth: 'none',\n    offset: 18, //px,\n    anchor: this.getPopupAnchor(event),\n  };\n\n  this.popupHandle = new Popup(popupOptions)\n    .setLngLat(poi.latLon)\n    .setHTML('<div class=\"poi_popup__wrapper\"/></div>')\n    .addTo(this.map);\n\n  const popupWrapper = document.querySelector('.poi_popup__wrapper');\n  if (popupWrapper) {\n    ReactDOM.render(<ReactPoiPopup poi={poi} />, popupWrapper);\n  }\n};\n\nPoiPopup.prototype.getPopupAnchor = function (event) {\n  const VERTICAL_OFFSET = 250;\n  const HORIZONTAL_OFFSET = 300;\n  const canvasWidth = window.innerWidth;\n  const anchorFragments = [];\n\n  if (event) {\n    if (event.clientY > VERTICAL_OFFSET) {\n      anchorFragments.push('bottom');\n    } else {\n      anchorFragments.push('top');\n    }\n\n    if (event.clientX < canvasWidth - HORIZONTAL_OFFSET) {\n      anchorFragments.push('left');\n    } else {\n      anchorFragments.push('right');\n    }\n  } else {\n    anchorFragments.push('bottom');\n    anchorFragments.push('left');\n  }\n\n  return anchorFragments.join('-');\n};\n\nPoiPopup.prototype.close = function () {\n  if (this.popupHandle) {\n    fire('stop_close_popup_timeout');\n    const popupWrapper = document.querySelector('.poi_popup__wrapper');\n    if (popupWrapper) {\n      ReactDOM.unmountComponentAtNode(popupWrapper);\n    }\n    this.popupHandle.remove();\n    this.popupHandle = null;\n  }\n};\n\n/* private */\nfunction isTouchEvent(event) {\n  if (event && event.originalEvent && event.originalEvent.sourceCapabilities) {\n    return event.originalEvent.sourceCapabilities.firesTouchEvents === true;\n  }\n  return false;\n}\n\nexport default PoiPopup;\n","export default class MobileCompassControl {\n  constructor() {\n    this._container = document.createElement('div');\n    const compassClass = 'map_control_group__button__compass--mobile';\n    this._compass = this._createButton(compassClass, 'Reset North', () => {\n      this._resetNorthAndTilt();\n    });\n\n    const compassIndicatorClass = 'map_control__compass__icon map_control__compass__icon--mobile';\n    this._compassIndicator = this._createIcon(compassIndicatorClass);\n    this._compass.appendChild(this._compassIndicator);\n  }\n\n  onAdd(map) {\n    this._map = map;\n    this._container.className = 'map_control_group';\n    this._container.textContent = '';\n    this._container.appendChild(this._compass);\n    const _pitchAndRotateCompassArrow = this._pitchAndRotateCompassArrow.bind(this);\n\n    _pitchAndRotateCompassArrow();\n\n    this._map.on('rotate', _pitchAndRotateCompassArrow);\n    this._map.on('pitch', _pitchAndRotateCompassArrow);\n\n    return this._container;\n  }\n\n  onRemove() {\n    this._container.parentNode.removeChild(this._container);\n    this._map = undefined;\n  }\n\n  _geolocate() {\n    navigator.geolocation.getCurrentPosition(\n      position => {\n        this._map.flyTo({ center: [position.coords.longitude, position.coords.latitude] });\n      },\n      () => undefined,\n      { maximumAge: 10000 }\n    );\n  }\n\n  _createButton(className, ariaLabel, fn) {\n    const a = document.createElement('button');\n    a.setAttribute('class', className);\n    a.setAttribute('aria-label', ariaLabel);\n    a.addEventListener('click', fn);\n    this._container.appendChild(a);\n    return a;\n  }\n\n  _createIcon(className) {\n    const a = document.createElement('span');\n    a.setAttribute('class', className);\n    return a;\n  }\n\n  _resetNorthAndTilt() {\n    this._map.easeTo({ pitch: 0, bearing: 0 });\n  }\n\n  _pitchAndRotateCompassArrow() {\n    if (this._map.getPitch() === 0 && this._map.transform.angle === 0) {\n      this._compass.classList.add('compass-origin');\n    } else {\n      this._compass.classList.remove('compass-origin');\n    }\n    const scale = 1 - this._map.getPitch() / 110;\n    const rotation = this._map.transform.angle * (180 / Math.PI);\n    this._compassIndicator.style.transform = `scale(1, ${scale}) rotate(${rotation}deg)`;\n  }\n}\n","import { ScaleControl } from 'mapbox-gl--ENV';\n\n/**\n * Override default control to pass a container\n * in constructor and register a onReady cb\n */\nexport default class ExtendedScaleControl extends ScaleControl {\n  constructor(options, container) {\n    super(options);\n    this.parentContainer = container;\n  }\n\n  onAdd(map) {\n    this._map = map;\n    this._container = document.createElement('div');\n    this._container.className = 'mapboxgl-ctrl mapboxgl-ctrl-scale map_control__scale';\n\n    this.parentContainer.appendChild(this._container);\n\n    this._map.on('move', this._onMove);\n    super._onMove();\n\n    return this.parentContainer;\n  }\n}\n","import { AttributionControl } from 'mapbox-gl--ENV';\n\n/**\n * Override default control to pass a container\n * in constructor and register a onReady cb\n */\nexport default class ExtendedAttributionControl extends AttributionControl {\n  constructor(options, container) {\n    super(options);\n    this.parentContainer = container;\n  }\n\n  onAdd(map) {\n    const container = super.onAdd(map);\n    if (container) {\n      this.parentContainer.appendChild(container);\n    }\n    return this.parentContainer;\n  }\n}\n","import ReactDOMServer from 'react-dom/server';\n\nexport default reactElement => ReactDOMServer.renderToStaticMarkup(reactElement);\n","import React from 'react';\nimport * as Geolocation from '../libs/geolocation';\nimport Telemetry from '../libs/telemetry';\nimport { openPendingGeolocateModal } from 'src/modals/GeolocationModal';\nimport * as store from 'src/adapters/store';\nimport renderStaticReact from 'src/libs/renderStaticReact';\nimport { IconGeoloc } from 'src/components/ui/icons';\nimport { isMobileDevice } from 'src/libs/device';\n\nimport { GeolocateControl } from 'mapbox-gl--ENV';\n\n/**\n * Override default GeolocateControl\n */\n\nexport default class ExtendedGeolocateControl extends GeolocateControl {\n  constructor(options, container) {\n    super(options);\n    this._container = container;\n    this.on('trackuserlocationstart', () => {\n      Telemetry.addOnce(Telemetry.LOCALISE_TRIGGER);\n    });\n  }\n\n  onAdd(map) {\n    this._map = map;\n    this._setupUI();\n    return this._container;\n  }\n\n  onReady(cb) {\n    this._onReady = cb;\n  }\n\n  async trigger() {\n    const state = await Geolocation.getGeolocationPermission();\n    if (\n      state === Geolocation.geolocationPermissions.PROMPT &&\n      !store.get('has_geolocate_modal_opened_once')\n    ) {\n      await openPendingGeolocateModal();\n      store.set('has_geolocate_modal_opened_once', true);\n    }\n    super.trigger();\n  }\n\n  _setupUI(supported) {\n    super._setupUI(supported);\n    if (this._geolocateButton?.firstChild) {\n      this._geolocateButton.firstChild.innerHTML = renderStaticReact(\n        <IconGeoloc fill=\"currentColor\" width={isMobileDevice() ? 24 : 16} />\n      );\n    }\n    this._onReady();\n  }\n\n  _onError(error) {\n    Geolocation.handleError(error);\n    super._onError(error);\n    // MapboxGL implementation disables the button after an error,\n    // but we won't the user to always have feedback with relevant links\n    // so override this behavior\n    this._geolocateButton.disabled = false;\n  }\n}\n","import React from 'react';\nimport ExtendedScaleControl from './extended_scale_control';\nimport ExtendedAttributionControl from './extended_attribution_control';\nimport GeolocControl from './extended_geolocate_control';\nimport Telemetry from 'src/libs/telemetry';\nimport { listen, unListen } from '../libs/customEvents';\nimport renderStaticReact from 'src/libs/renderStaticReact';\nimport { IconPlus, IconMinus } from 'src/components/ui/icons';\n\nexport default class ExtendedControl {\n  constructor() {\n    this._container = document.createElement('div');\n    this.topButtonGroup = document.createElement('div');\n    this.bottomButtonGroup = document.createElement('div');\n\n    // Store a callback to trigger when direction shortcut is clicked.\n    // if no callback is registered, then the default action will be executed\n    // (navigate to /routes)\n    this.directionShortcutCallback = null;\n    listen('set_direction_shortcut_callback', cb => (this.directionShortcutCallback = cb));\n\n    this._zoomInButton = this._createButton(\n      'map_control_group__button__zoom map-button--zoomIn',\n      'Zoom +',\n      () => {\n        Telemetry.add(Telemetry.MAP_ZOOM_IN);\n        this._map.zoomIn();\n      }\n    );\n    this._zoomInButton.innerHTML = renderStaticReact(<IconPlus fill=\"currentColor\" width={16} />);\n\n    this._zoomOutButton = this._createButton(\n      'map_control_group__button__zoom map-button--zoomOut',\n      'Zoom -',\n      () => {\n        Telemetry.add(Telemetry.MAP_ZOOM_OUT);\n        this._map.zoomOut();\n      }\n    );\n    this._zoomOutButton.innerHTML = renderStaticReact(<IconMinus fill=\"currentColor\" width={16} />);\n\n    const compassClass = 'map_control_group__button__compass';\n    this._compass = this._createButton(compassClass, 'Reset North', () => {\n      this._resetNorthAndTilt();\n    });\n    this._direction = this._createButton('direction_shortcut hidden', 'direction', () => {\n      Telemetry.add(Telemetry.MAP_ITINERARY);\n      this.directionShortcutCallback\n        ? this.directionShortcutCallback()\n        : window.app.navigateTo('/routes'); // default action, if no cb has been set\n    });\n\n    this._compassIndicator = this._createIcon('map_control__compass__icon');\n    this._compass.appendChild(this._compassIndicator);\n  }\n\n  onAdd(map) {\n    this._map = map;\n    this.topButtonGroup.className = 'map_control_group';\n    this.topButtonGroup.textContent = '';\n    this.bottomButtonGroup.className = 'map_control_group map_bottom_button_group mapboxgl-ctrl';\n    this.bottomButtonGroup.textContent = '';\n\n    const geolocControl = new GeolocControl(\n      {\n        positionOptions: {\n          enableHighAccuracy: true,\n        },\n        trackUserLocation: true,\n        showAccuracyCircle: false,\n      },\n      this.bottomButtonGroup\n    );\n\n    this.topButtonGroup.appendChild(this._compass);\n    this.topButtonGroup.appendChild(this._direction);\n\n    geolocControl.onReady(() => {\n      this.bottomButtonGroup.appendChild(this._zoomInButton);\n      this.bottomButtonGroup.appendChild(this._zoomOutButton);\n    });\n\n    this._map.addControl(geolocControl);\n\n    const _pitchAndRotateCompassArrow = this._pitchAndRotateCompassArrow.bind(this);\n\n    _pitchAndRotateCompassArrow();\n\n    this._map.on('rotate', _pitchAndRotateCompassArrow);\n    this._map.on('pitch', _pitchAndRotateCompassArrow);\n\n    this.scaleAttributionContainer = document.createElement('div');\n    this.scaleAttributionContainer.className = 'map_control__scale_attribute_container';\n    this._container.appendChild(this.scaleAttributionContainer);\n\n    const extendedScaleControl = new ExtendedScaleControl(\n      {\n        unit: 'metric',\n      },\n      this.scaleAttributionContainer\n    );\n\n    const extendedAttributionControl = new ExtendedAttributionControl(\n      {},\n      this.scaleAttributionContainer\n    );\n    this._container.appendChild(this.topButtonGroup);\n    this._container.appendChild(this.bottomButtonGroup);\n\n    this._container.appendChild(this.scaleAttributionContainer);\n    this._map.addControl(extendedScaleControl, 'bottom-right');\n    this._map.addControl(extendedAttributionControl, 'bottom-right');\n    return this._container;\n  }\n\n  onRemove() {\n    this._container.parentNode.removeChild(this._container);\n    this._map = undefined;\n    unListen('set_direction_shortcut_callback');\n  }\n\n  _createButton(className, ariaLabel, fn) {\n    const a = document.createElement('button');\n    a.setAttribute('class', className);\n    a.setAttribute('aria-label', ariaLabel);\n    a.setAttribute('title', ariaLabel);\n    a.addEventListener('click', fn);\n    return a;\n  }\n\n  _createIcon(className) {\n    const a = document.createElement('span');\n    a.setAttribute('class', className);\n    return a;\n  }\n\n  _resetNorthAndTilt() {\n    this._map.easeTo({ pitch: 0, bearing: 0 });\n  }\n\n  _pitchAndRotateCompassArrow() {\n    if (this._map.getPitch() === 0 && this._map.transform.angle === 0) {\n      this._compass.classList.add('compass-origin');\n    } else {\n      this._compass.classList.remove('compass-origin');\n    }\n    const scale = 1 - this._map.getPitch() / 110;\n    const rotation = this._map.transform.angle * (180 / Math.PI);\n    this._compassIndicator.style.transform = `scale(1, ${scale}) rotate(${rotation}deg)`;\n  }\n}\n","import { LngLat } from 'mapbox-gl--ENV';\nimport Poi, { POI_TYPE } from './poi';\n\nexport default class MapPoi extends Poi {\n  constructor(feature) {\n    const { global_id, ['class']: className, subclass: subClassName, name } = feature.properties;\n    const ll = LngLat.convert(feature.geometry.coordinates);\n    super(global_id || feature.id, name, POI_TYPE, ll, className, subClassName);\n  }\n}\n","import nconf from '@qwant/nconf-getter';\nimport configure from '@qwant/mapbox_style_configure';\nimport URI from '@qwant/uri';\nimport qwantStyle from '@qwant/qwant-basic-gl-style/style.json';\n\nconst mapStyleConfig = nconf.get().mapStyle;\nconst baseUrl = nconf.get().system.baseUrl;\n\nfunction sceneConfig() {\n  return Object.assign(mapStyleConfig, {\n    spritesUrl: URI.toAbsoluteUrl(location.origin, baseUrl, mapStyleConfig.spritesUrl),\n    fontsUrl: URI.toAbsoluteUrl(location.origin, baseUrl, mapStyleConfig.fontsUrl),\n  });\n}\n\nexport default function getStyle() {\n  return configure(JSON.stringify(qwantStyle), sceneConfig(), window.getBaseLang().code);\n}\n","import React from 'react';\nimport { formatDistance, formatDuration } from 'src/libs/route_utils';\nimport VehicleIcon from '../VehicleIcon';\n\nconst VEHICLES = {\n  TRAIN: 'train',\n  SUBWAY: 'metro',\n  SUBURBAN_TRAIN: 'metro',\n  BUS_CITY: 'bus',\n  TRAM: 'tram',\n};\n\nconst PublicTransportIcon = ({ mode }) => (\n  <div className={`publicTransportLabelItem roadmapIcon roadmapIcon--${VEHICLES[mode]}`} />\n);\n\nconst PublicTransportStepIcons = ({ route }) => {\n  const nonWalkLegs = route.legs.filter(leg => leg.mode !== 'WALK');\n\n  if (nonWalkLegs.length <= 3) {\n    return (\n      <div>\n        {nonWalkLegs.map((leg, index) => (\n          <PublicTransportIcon key={index} mode={leg.mode} />\n        ))}\n      </div>\n    );\n  }\n\n  return (\n    <div>\n      <PublicTransportIcon mode={nonWalkLegs[0].mode} />\n      <div className=\"publicTransportLabelItem roadmapIcon u-text--caption roadmapIcon--inbetween\">\n        <div>+{nonWalkLegs.length - 2}</div>\n      </div>\n      <PublicTransportIcon mode={nonWalkLegs[nonWalkLegs.length - 1].mode} />\n    </div>\n  );\n};\n\nconst RouteLabel = ({ route, vehicle, anchor }) => {\n  const isPublicTransport = vehicle === 'publicTransport';\n  return (\n    <div data-id={route.id} className={`routeLabel routeLabel--${anchor} routeLabel--${vehicle}`}>\n      {isPublicTransport ? (\n        <PublicTransportStepIcons route={route} />\n      ) : (\n        <div className=\"routeLabel-vehicleIcon\">\n          <VehicleIcon vehicle={vehicle} fill=\"currentColor\" width={24} />\n        </div>\n      )}\n      <div>\n        <div className=\"routeLabel-duration\">{formatDuration(route.duration)}</div>\n        {!isPublicTransport && (\n          <div className=\"routeLabel-distance\">{formatDistance(route.distance)}</div>\n        )}\n      </div>\n    </div>\n  );\n};\n\nexport default RouteLabel;\n","import Color from 'color';\n\nconst darkenColor = hex => Color(hex).mix(Color('black'), 0.33).hex();\nconst safeHexColor = hex => (hex.charAt(0) === '#' ? hex : `#${hex}`);\n\nexport function prepareRouteColor(feature) {\n  const lineColor = feature.properties?.lineColor;\n  return {\n    ...feature,\n    properties: {\n      ...feature.properties,\n      lineColor: lineColor ? safeHexColor(lineColor) : '#57C78E',\n      outlineColor: lineColor ? darkenColor(safeHexColor(lineColor)) : '#297A52',\n    },\n  };\n}\n\nfunction getColorExpression(isActive, isOutline) {\n  if (isActive) {\n    return isOutline ? ['get', 'outlineColor'] : ['get', 'lineColor'];\n  }\n  return isOutline ? '#676E79' : '#C7CBD1';\n}\n\nexport function getRouteStyle(vehicle, isActive, isOutline) {\n  if (vehicle === 'walking') {\n    return {\n      type: 'symbol',\n      layout: {\n        'icon-image': isActive ? 'walking_bullet_active' : 'walking_bullet_inactive',\n        'symbol-placement': 'line',\n        'symbol-spacing': 12,\n        'icon-ignore-placement': true,\n        'icon-allow-overlap': true,\n        'symbol-avoid-edges': true,\n      },\n    };\n  }\n\n  return {\n    type: 'line',\n    layout: {\n      'line-join': 'round',\n      'line-cap': 'round',\n      visibility: 'visible',\n    },\n    paint: {\n      'line-color': getColorExpression(isActive, isOutline),\n      'line-color-transition': { duration: 0 },\n      'line-width': isOutline ? 9 : 5,\n    },\n  };\n}\n\nexport function setActiveRouteStyle(map, layerId, vehicle, isActive, isOutline) {\n  if (vehicle === 'walking') {\n    map.setLayoutProperty(\n      layerId,\n      'icon-image',\n      isActive ? 'walking_bullet_active' : 'walking_bullet_inactive'\n    );\n  } else {\n    map.setPaintProperty(layerId, 'line-color', getColorExpression(isActive, isOutline));\n  }\n}\n","import React from 'react';\nimport RouteLabel from 'src/panel/direction/RouteLabel';\nimport { Marker, LngLatBounds } from 'mapbox-gl--ENV';\nimport bbox from '@turf/bbox';\nimport { normalizeToFeatureCollection } from 'src/libs/geojson';\nimport { map } from '../../config/constants.yml';\nimport LatLonPoi from '../adapters/poi/latlon_poi';\nimport { prepareRouteColor, getRouteStyle, setActiveRouteStyle } from './route_styles';\nimport { getAllSteps, getAllStops, originDestinationCoords } from 'src/libs/route_utils';\nimport Error from '../adapters/error';\nimport nconf from '@qwant/nconf-getter';\nimport { fire, listen } from 'src/libs/customEvents';\nimport { getLabelPositions } from 'alt-route-labeller';\nimport { isMobileDevice } from 'src/libs/device';\nimport renderStaticReact from 'src/libs/renderStaticReact';\n\nconst createMarker = (lngLat, className = '', options = {}) => {\n  const element = document.createElement('div');\n  element.className = className;\n  return new Marker({ ...options, element }).setLngLat(lngLat);\n};\n\nconst createRouteLabel = (route, vehicle, { lngLat, anchor }) => {\n  const element = document.createElement('div');\n  element.innerHTML = renderStaticReact(\n    <RouteLabel route={route} vehicle={vehicle} anchor={anchor} />\n  );\n  element.className = 'routeLabel-marker';\n  element.onclick = () => {\n    fire('select_road_map', route.id);\n  };\n  return new Marker({ element, anchor }).setLngLat(lngLat);\n};\n\nconst getLabelsBbbox = (labelPositions, routesBbox) => {\n  const smallScreen = isMobileDevice();\n  const shift = {\n    latShift: (routesBbox.getNorth() - routesBbox.getSouth()) / (smallScreen ? 5 : 10),\n    lngShift: (routesBbox.getEast() - routesBbox.getWest()) / (smallScreen ? 3 : 10),\n  };\n  const labelsBbbox = new LngLatBounds();\n  labelPositions.map(shiftLabelPosition(shift)).forEach(labelPosition => {\n    labelsBbbox.extend(labelPosition);\n  });\n  return labelsBbbox;\n};\n\nconst shiftLabelPosition =\n  ({ lngShift, latShift }) =>\n  ({ lngLat, anchor }) => {\n    let [lng, lat] = lngLat;\n    if (anchor === 'top') {\n      lat -= latShift;\n    } else if (anchor === 'bottom') {\n      lat += latShift;\n    } else if (anchor === 'left') {\n      lng += lngShift;\n    } else if (anchor === 'right') {\n      lng -= lngShift;\n    }\n    return [lng, lat];\n  };\n\nexport default class SceneDirection {\n  constructor(map) {\n    this.map = map;\n    this.routes = [];\n    this.routeMarkers = [];\n    this.routeLabels = [];\n    this.fullBbox = null;\n    this.mapFeaturesByRoute = {};\n\n    const iconsBaseUrl = nconf.get().system.baseUrl + 'statics/images/direction_icons';\n    this.addMapImage(`${iconsBaseUrl}/walking_bullet_active.png`, 'walking_bullet_active', {\n      pixelRatio: 4,\n    });\n    this.addMapImage(`${iconsBaseUrl}/walking_bullet_inactive.png`, 'walking_bullet_inactive', {\n      pixelRatio: 4,\n    });\n\n    listen('set_routes', ({ routes, vehicle, activeRouteId = 0 }) => {\n      this.reset();\n      this.routes = routes;\n      this.vehicle = vehicle;\n      this.displayRoutes(activeRouteId);\n    });\n\n    listen('set_main_route', ({ routeId, fitView }) => {\n      this.setMainRoute(routeId, fitView);\n    });\n\n    listen('clean_routes', () => {\n      this.reset();\n    });\n\n    listen('zoom_step', step => {\n      fire('fit_map', this.computeBBox(step));\n    });\n\n    listen('highlight_step', step => {\n      this.highlightStep(step);\n    });\n\n    listen('unhighlight_step', step => {\n      this.unhighlightStep(step);\n    });\n\n    listen('set_origin', poi => {\n      this.setOrigin(poi);\n    });\n\n    listen('set_destination', poi => {\n      this.setDestination(poi);\n    });\n  }\n\n  setOrigin = poi => {\n    const originMarker = createMarker(poi.latLon, 'itinerary_marker_origin', {\n      draggable: !isMobileDevice(),\n    })\n      .addTo(this.map)\n      .on('dragend', event => {\n        this.refreshDirection('origin', event.target.getLngLat());\n      });\n    this.routeMarkers.push(originMarker);\n  };\n\n  setDestination = poi => {\n    const destinationMarker = createMarker(poi.latLon, 'itinerary_marker_destination', {\n      draggable: !isMobileDevice(),\n      anchor: 'bottom',\n    })\n      .addTo(this.map)\n      .on('dragend', event => {\n        this.refreshDirection('destination', event.target.getLngLat());\n      });\n    this.routeMarkers.push(destinationMarker);\n  };\n\n  addMarkerSteps(route) {\n    if (this.vehicle !== 'walking' && this.vehicle !== 'publicTransport') {\n      getAllSteps(route).forEach((step, idx) => {\n        const stepMarker = createMarker(step.maneuver.location, 'itinerary_marker_step');\n        stepMarker.getElement().id = 'itinerary_marker_step_' + idx;\n        this.routeMarkers.push(stepMarker.addTo(this.map));\n      });\n    }\n\n    if (this.vehicle === 'publicTransport') {\n      getAllStops(route).forEach((stop, idx) => {\n        const stopMarker = createMarker(stop.location, 'itinerary_marker_step');\n        stopMarker.getElement().id = 'itinerary_marker_stop_' + idx;\n        stopMarker.getElement().title = stop.name;\n        this.routeMarkers.push(stopMarker.addTo(this.map));\n      });\n    }\n  }\n\n  setMainRoute(routeId, fitView) {\n    let mainRoute = null;\n    if (this.routes.length === 0) {\n      return;\n    }\n\n    this.routes.forEach(route => {\n      const isActive = route.id === routeId;\n      if (isActive) {\n        mainRoute = route;\n      }\n      this.mapFeaturesByRoute[route.id].forEach(({ layerId, outlineLayerId, vehicle }) => {\n        setActiveRouteStyle(this.map, layerId, vehicle, isActive, false);\n        if (outlineLayerId) {\n          setActiveRouteStyle(this.map, outlineLayerId, vehicle, isActive, true);\n        }\n        if (isActive) {\n          if (outlineLayerId) {\n            this.map.moveLayer(outlineLayerId, map.routes_layer);\n          }\n          this.map.moveLayer(layerId, map.routes_layer);\n        }\n      });\n    });\n    this.updateMarkers(mainRoute);\n    this.updateRouteLabels(mainRoute);\n    if (fitView && this.fullBbox) {\n      fire('fit_map', this.fullBbox);\n    }\n  }\n\n  updateMarkers(mainRoute) {\n    if (!mainRoute) {\n      return;\n    }\n\n    this.routeMarkers.forEach(marker => {\n      marker.remove();\n    });\n    this.routeMarkers = [];\n\n    this.addMarkerSteps(mainRoute);\n    const { origin, destination } = originDestinationCoords(mainRoute);\n\n    this.setOrigin({ latLon: { lng: origin[0], lat: origin[1] } });\n\n    this.setDestination({ latLon: { lng: destination[0], lat: destination[1] } });\n  }\n\n  displayRoutes(activeRouteId) {\n    if (this.routes && this.routes.length > 0) {\n      // route lines\n      this.mapFeaturesByRoute = {};\n      this.routes.forEach(route => {\n        this.mapFeaturesByRoute[route.id] = this.addRouteFeatures(\n          route,\n          route.id === activeRouteId\n        );\n      });\n      // route labels\n      const labelPositions = getLabelPositions(this.routes.map(route => route.geometry));\n      this.routeLabels = labelPositions.map(({ lngLat, anchor }, index) =>\n        createRouteLabel(this.routes[index], this.vehicle, { lngLat, anchor }).addTo(this.map)\n      );\n      // compute and store the best bbox\n      const routesBbox = new LngLatBounds();\n      this.routes.forEach(route => {\n        routesBbox.extend(this.computeBBox(route));\n      });\n      this.fullBbox = routesBbox.extend(getLabelsBbbox(labelPositions, routesBbox));\n\n      this.setMainRoute(activeRouteId, true);\n    }\n  }\n\n  updateRouteLabels({ id: activeRouteId }) {\n    // @IE11: array spread to convert NodeList to an array\n    [...document.querySelectorAll('.routeLabel')].forEach(routeLabel => {\n      if (routeLabel.dataset.id === activeRouteId.toString()) {\n        routeLabel.classList.add('active');\n      } else {\n        routeLabel.classList.remove('active');\n      }\n    });\n  }\n\n  refreshDirection(type, lngLat) {\n    const newPoint = new LatLonPoi(lngLat);\n    fire('change_direction_point', type, '', newPoint);\n  }\n\n  reset() {\n    this.routes.forEach(route => {\n      this.mapFeaturesByRoute[route.id].forEach(({ outlineLayerId, layerId, sourceId }) => {\n        if (outlineLayerId) {\n          this.map.removeLayer(outlineLayerId);\n        }\n        this.map.removeLayer(layerId);\n        this.map.removeSource(sourceId);\n      });\n    });\n    this.routes = [];\n\n    this.routeMarkers.concat(this.routeLabels).forEach(marker => {\n      marker.remove();\n    });\n    this.routeMarkers = [];\n    this.routeLabels = [];\n    this.fullBbox = null;\n  }\n\n  getDataSources(route) {\n    const featureCollection = normalizeToFeatureCollection(route.geometry);\n    const sources = [];\n    const walkFeatures = [],\n      nonWalkFeatures = [];\n    featureCollection.features.forEach(feature => {\n      if (\n        this.vehicle === 'walking' ||\n        (this.vehicle === 'publicTransport' && feature.properties.mode === 'WALK')\n      ) {\n        walkFeatures.push(feature);\n      } else {\n        nonWalkFeatures.push(prepareRouteColor(feature));\n      }\n    });\n\n    if (walkFeatures.length > 0) {\n      sources.push({\n        vehicle: 'walking',\n        data: { type: 'FeatureCollection', features: walkFeatures },\n      });\n    }\n\n    if (nonWalkFeatures.length > 0) {\n      sources.push({\n        vehicle: this.vehicle,\n        data: { type: 'FeatureCollection', features: nonWalkFeatures },\n      });\n    }\n\n    return sources;\n  }\n\n  addRouteFeatures(route, isActive) {\n    const sources = this.getDataSources(route);\n    return sources.map((source, idx) => {\n      const sourceId = `source_${route.id}_${idx}`;\n      this.map.addSource(sourceId, { type: 'geojson', data: source.data });\n\n      const layerId = `route_${route.id}_${idx}`;\n      const layerStyle = {\n        ...getRouteStyle(source.vehicle, isActive, false),\n        id: layerId,\n        source: sourceId,\n      };\n\n      let outlineLayerId;\n      if (source.vehicle !== 'walking') {\n        outlineLayerId = layerId + '_outline';\n        const outlineLayerStyle = {\n          ...getRouteStyle(source.vehicle, isActive, true),\n          id: layerId + '_outline',\n          source: sourceId,\n        };\n        this.map.addLayer(outlineLayerStyle, map.routes_layer);\n      }\n\n      this.map\n        .addLayer(layerStyle, map.routes_layer)\n        .on('click', layerId, () => {\n          fire('select_road_map', route.id);\n        })\n        .on('mouseenter', layerId, () => {\n          this.map.getCanvas().style.cursor = 'pointer';\n        })\n        .on('mouseleave', layerId, () => {\n          this.map.getCanvas().style.cursor = '';\n        });\n\n      return { sourceId, layerId, outlineLayerId, vehicle: source.vehicle };\n    });\n  }\n\n  computeBBox({ geometry }) {\n    const [minX, minY, maxX, maxY] = bbox(geometry);\n    return new LngLatBounds([minX, minY], [maxX, maxY]);\n  }\n\n  highlightStep(step) {\n    const marker = document.querySelector('#itinerary_marker_step_' + step);\n    if (marker) {\n      marker.classList.add('itinerary_marker_step--highlighted');\n    }\n  }\n\n  unhighlightStep(step) {\n    const marker = document.querySelector('#itinerary_marker_step_' + step);\n    if (marker) {\n      marker.classList.remove('itinerary_marker_step--highlighted');\n    }\n  }\n\n  addMapImage(url, name, options = {}) {\n    this.map.loadImage(url, (error, image) => {\n      if (error) {\n        Error.sendOnce('scene', 'initMapBox', `Failed to load image at ${url}`, error);\n        return;\n      }\n      this.map.addImage(name, image, options);\n    });\n  }\n}\n","import nconf from '@qwant/nconf-getter';\nimport { Marker } from 'mapbox-gl--ENV';\nimport constants from '../../config/constants.yml';\nimport Telemetry from 'src/libs/telemetry';\nimport { toUrl } from 'src/libs/pois';\nimport { fire, listen } from 'src/libs/customEvents';\nimport { poiToGeoJSON, emptyFeatureCollection } from 'src/libs/geojson';\nimport { getFilteredPoisPinStyle, getFilteredPoisLabelStyle } from 'src/adapters/pois_styles';\nimport { isMobileDevice } from 'src/libs/device';\nimport { createMapGLIcon, createPinIcon } from 'src/adapters/icon_manager';\nimport IconManager from 'src/adapters/icon_manager';\n\nconst mapStyleConfig = nconf.get().mapStyle;\n\nconst poisToGeoJSON = pois => {\n  return {\n    type: 'FeatureCollection',\n    features: pois.map(poi => {\n      const poiFeature = poiToGeoJSON(poi);\n      poiFeature.properties.iconName = IconManager.get(poi).iconClass;\n      return poiFeature;\n    }),\n  };\n};\n\nexport default class SceneCategory {\n  constructor(map) {\n    this.map = map;\n    this.sourceName = 'poi-filtered';\n    this.layers = [];\n\n    this.initActiveStateMarkers();\n    this.initDynamicPoiLayers();\n\n    listen('add_category_markers', this.addCategoryMarkers);\n    listen('remove_category_markers', this.removeCategoryMarkers);\n    listen('highlight_category_marker', this.highlightPoiMarker);\n    listen('click_category_marker', this.selectPoiMarker);\n    listen('click_category_poi', this.selectPoi);\n    listen('clean_marker', () => this.selectPoiMarker(null));\n  }\n\n  initActiveStateMarkers = () => {\n    this.hoveredPoi = null;\n    this.hoveredMarker = new Marker({\n      element: createPinIcon({ disablePointerEvents: true, className: 'marker--category' }),\n      anchor: 'bottom',\n    });\n    this.selectedPoi = null;\n    this.selectedMarker = new Marker({\n      element: createPinIcon({ className: 'marker--category' }),\n      anchor: 'bottom',\n    });\n  };\n\n  initDynamicPoiLayers = () => {\n    // Declare a new image in MapBox-GL rasters so it can be used in the layer style\n    createMapGLIcon('./statics/images/map/pin_map_dot.svg', 50, 60).then(imageData => {\n      this.map.addImage('pin_with_dot', imageData);\n    });\n\n    this.map.addSource(this.sourceName, {\n      type: 'geojson',\n      data: emptyFeatureCollection,\n      // tells MapBox-GL to use this property as internal feature identifier\n      promoteId: 'id',\n    });\n\n    if (mapStyleConfig.showNamesWithPins) {\n      const labelLayerId = `${this.sourceName}_labels`;\n      this.map.addLayer({\n        ...getFilteredPoisLabelStyle(),\n        source: this.sourceName,\n        id: labelLayerId,\n      });\n      this.layers.push(labelLayerId);\n    }\n\n    const pinLayerId = `${this.sourceName}_pins`;\n    this.map.addLayer({\n      ...getFilteredPoisPinStyle(),\n      source: this.sourceName,\n      id: pinLayerId,\n    });\n    this.layers.push(pinLayerId);\n\n    this.layers.forEach(layerName => {\n      this.map.on('click', layerName, this.handleLayerMarkerClick);\n      if (!isMobileDevice()) {\n        this.map.on('mouseover', layerName, this.handleLayerMarkerMouseOver);\n        this.map.on('mouseleave', layerName, this.handleLayerMarkerMouseLeave);\n      }\n    });\n  };\n\n  getPointedPoi = mapMouseEvent => {\n    const feature = mapMouseEvent.features[0];\n    return feature && this.pois.find(p => p.id === feature.id);\n  };\n\n  selectPoi = ({ poi, poiFilters, pois }) => {\n    if (poi.meta && poi.meta.source) {\n      Telemetry.sendPoiEvent(\n        poi,\n        'open',\n        Telemetry.buildInteractionData({\n          id: poi.id,\n          source: poi.meta.source,\n          template: 'multiple',\n          zone: 'list',\n          element: 'item',\n          category: poiFilters.category,\n        })\n      );\n    }\n    window.app.navigateTo(`/place/${toUrl(poi)}`, {\n      poi,\n      poiFilters,\n      pois,\n      centerMap: true,\n    });\n    this.selectPoiMarker(poi);\n  };\n\n  handleLayerMarkerClick = e => {\n    e.originalEvent.stopPropagation();\n    const poi = this.getPointedPoi(e);\n\n    this.selectPoi({\n      poi,\n      pois: this.pois,\n      poiFilters: this.poiFilters,\n    });\n  };\n\n  handleLayerMarkerMouseOver = e => {\n    this.map.getCanvas().style.cursor = 'pointer';\n    const poi = this.getPointedPoi(e);\n    if (this.selectedPoi?.id !== poi.id) {\n      this.highlightPoiMarker(poi, true);\n      fire('open_popup', poi, e.originalEvent);\n    }\n  };\n\n  handleLayerMarkerMouseLeave = () => {\n    this.map.getCanvas().style.cursor = '';\n    this.highlightPoiMarker(this.hoveredPoi, false);\n    // delay the popup closure so it can be hovered\n    fire('start_close_popup_timeout');\n  };\n\n  addCategoryMarkers = (pois = [], poiFilters) => {\n    fire('close_popup');\n    this.pois = pois;\n    this.poiFilters = poiFilters;\n    this.setOsmPoisVisibility(false);\n    this.map.getSource(this.sourceName).setData(poisToGeoJSON(pois));\n    this.layers.forEach(layerName => {\n      this.map.setLayoutProperty(layerName, 'visibility', 'visible');\n    });\n  };\n\n  removeCategoryMarkers = () => {\n    fire('close_popup');\n    this.selectPoiMarker(null);\n    this.highlightPoiMarker(this.hoveredPoi, false);\n    this.layers.forEach(layerName => {\n      this.map.setLayoutProperty(layerName, 'visibility', 'none');\n    });\n    this.setOsmPoisVisibility(true);\n  };\n\n  setOsmPoisVisibility = displayed => {\n    constants.map.pois_layers.map(poi => {\n      this.map.setLayoutProperty(poi, 'visibility', displayed ? 'visible' : 'none');\n    });\n  };\n\n  setPoiFeatureState = (id, state) => {\n    this.map.setFeatureState({ id, source: this.sourceName }, state);\n  };\n\n  highlightPoiMarker = (poi, highlight) => {\n    if (this.hoveredPoi) {\n      this.setPoiFeatureState(this.hoveredPoi.id, { hovered: false });\n    }\n    if (highlight) {\n      this.hoveredPoi = poi;\n      this.hoveredMarker.setLngLat(poi.latLon).addTo(this.map);\n      this.setPoiFeatureState(this.hoveredPoi.id, { hovered: true });\n    } else {\n      this.hoveredMarker.remove();\n      this.hoveredPoi = null;\n    }\n  };\n\n  selectPoiMarker = poi => {\n    if (this.selectedPoi === poi) {\n      return;\n    }\n    if (this.selectedPoi) {\n      this.setPoiFeatureState(this.selectedPoi.id, { selected: false });\n    }\n    if (poi) {\n      this.selectedPoi = poi;\n      this.selectedMarker.setLngLat(poi.latLon).addTo(this.map);\n      this.setPoiFeatureState(this.selectedPoi.id, { selected: true });\n    } else {\n      this.selectedMarker.remove();\n      this.selectedPoi = null;\n    }\n  };\n}\n","import { Map, Marker, LngLat, setRTLTextPlugin, LngLatBounds } from 'mapbox-gl--ENV';\nimport PoiPopup from './poi_popup';\nimport MobileCompassControl from '../mapbox/mobile_compass_control';\nimport ExtendedControl from '../mapbox/extended_nav_control';\nimport { map as mapConfig } from 'config/constants.yml';\nimport { getCurrentMapPaddings, isPositionUnderUI } from 'src/panel/layouts';\nimport nconf from '@qwant/nconf-getter';\nimport MapPoi from './poi/map_poi';\nimport { getLastLocation, setLastLocation } from 'src/adapters/store';\nimport getStyle from './scene_config';\nimport SceneDirection from './scene_direction';\nimport SceneCategory from './scene_category';\nimport { createDefaultPin } from '../adapters/icon_manager';\nimport LatLonPoi from './poi/latlon_poi';\nimport { isMobileDevice } from 'src/libs/device';\nimport { parseMapHash, getMapHash } from 'src/libs/url_utils';\nimport { parseBboxString } from 'src/libs/bounds';\nimport { toUrl, getBestZoom } from 'src/libs/pois';\nimport Error from 'src/adapters/error';\nimport { fire, listen } from 'src/libs/customEvents';\nimport locale from '../mapbox/locale';\nimport { setPoiHoverStyle } from 'src/adapters/pois_styles';\n\nconst baseUrl = nconf.get().system.baseUrl;\nconst LONG_TOUCH_DELAY_MS = 500;\nconst MOBILE_IDLE_DELAY_MS = 2000;\nlet MOBILE_IDLE_TIMEOUT;\n\nfunction Scene() {\n  this.currentMarker = null;\n  this.popup = new PoiPopup();\n  this.savedLocation = null;\n}\n\nconst getPoiView = poi => ({\n  center: poi.geometry.center,\n  zoom: getBestZoom(poi),\n  bounds: poi.geometry.bbox,\n});\n\nconst hideMobileScale = function () {\n  const item = document.querySelector('.map_control__scale');\n  if (item) {\n    item.classList.add('fadeOut');\n  }\n};\n\nconst showMobileScale = function () {\n  const item = document.querySelector('.map_control__scale');\n  if (item) {\n    item.classList.remove('fadeOut');\n  }\n};\n\nScene.prototype.getMapInitOptions = function ({ locationHash, bbox }) {\n  if (bbox) {\n    try {\n      return { bounds: parseBboxString(bbox) };\n    } catch (e) {\n      console.error(e);\n    }\n  }\n  if (window.hotLoadPoi) {\n    return getPoiView(window.hotLoadPoi);\n  }\n  if (locationHash) {\n    return {\n      zoom: locationHash.zoom,\n      center: [locationHash.lng, locationHash.lat],\n    };\n  }\n  const lastLocation = getLastLocation();\n  if (lastLocation) {\n    return {\n      zoom: lastLocation.zoom,\n      center: [lastLocation.lng, lastLocation.lat],\n    };\n  }\n  if (window.initialBbox) {\n    return {\n      bounds: window.initialBbox,\n      fitBoundsOptions: {\n        maxZoom: 9,\n      },\n    };\n  }\n  return {\n    zoom: mapConfig.zoom,\n    center: [mapConfig.center.lng, mapConfig.center.lat],\n  };\n};\n\nScene.prototype.initMapBox = function ({ locationHash, bbox }) {\n  window.times.initMapBox = Date.now();\n  const compilationHash = window.__config.compilationHash;\n  setRTLTextPlugin(\n    `${baseUrl}statics/build/javascript/map_plugins/mapbox-gl-rtl-text-${compilationHash}.js`,\n    error => {\n      if (error) {\n        Error.send('scene', 'setRTLTextPlugin', 'Failed to load mapbox RTL plugin', error);\n      }\n    },\n    /* lazy */ true\n  );\n\n  this.mb = new Map({\n    attributionControl: false,\n    container: 'scene_container',\n    style: getStyle(),\n    hash: false,\n    maxZoom: 20,\n    locale,\n    ...this.getMapInitOptions({ locationHash, bbox }),\n  });\n  // @MAPBOX: This method isn't implemented by the Mapbox-GL mock\n  this.mb.setPadding = this.mb.setPadding || (() => undefined);\n  this.mb.setPadding(getCurrentMapPaddings());\n\n  this.popup.init(this.mb);\n  window.map = this;\n\n  const interactiveLayers = [\n    'poi-level-1',\n    'poi-level-2',\n    'poi-level-3',\n    'poi-level-public-transports-1',\n    'poi-level-public-transports-2',\n  ];\n  this.hoveredPoi = null;\n\n  // Max time between two touch to be considered a single \"double click\" event\n  // This is the value Mapbox-GL uses, in src/ui/handler/dblclick_zoom.js\n  this.DOUBLE_TAP_DELAY_MS = 300;\n  this.lastDoubleTapTimeStamp = 0;\n  this.lastTouchEndTimeStamp = 0;\n  this.mb.on('touchend', () => {\n    const timeStamp = Date.now();\n    // maybe we should also check the distance between the two touch events\n    if (timeStamp - this.lastTouchEndTimeStamp < this.DOUBLE_TAP_DELAY_MS) {\n      this.lastDoubleTapTimeStamp = timeStamp;\n    }\n    this.lastTouchEndTimeStamp = timeStamp;\n  });\n\n  this.mb.on('load', () => {\n    fire('restart_idle_timeout');\n    this.onHashChange();\n    new SceneDirection(this.mb);\n    new SceneCategory(this.mb);\n\n    this.mb.addControl(new ExtendedControl(), 'bottom-right');\n    this.mb.addControl(new MobileCompassControl(), 'top-right');\n\n    if (!isMobileDevice()) {\n      interactiveLayers.forEach(interactiveLayer => {\n        setPoiHoverStyle(this.mb, interactiveLayer);\n\n        this.mb.on('mouseenter', interactiveLayer, e => {\n          if (e.features.length > 0) {\n            this.hoveredPoi = e.features[0];\n            this.mb.setFeatureState(this.hoveredPoi, { hover: true });\n          }\n          this.mb.getCanvas().style.cursor = 'pointer';\n        });\n\n        this.mb.on('mouseleave', interactiveLayer, () => {\n          if (this.hoveredPoi) {\n            this.mb.setFeatureState(this.hoveredPoi, { hover: false });\n            this.hoveredPoi = null;\n          }\n          this.mb.getCanvas().style.cursor = '';\n        });\n\n        this.popup.addListener(interactiveLayer);\n      });\n    }\n\n    // we have to delay click event resolution to make time for possible double click events,\n    // which are thrown *after* two separate click events are thrown\n    this.clickDelayHandler = null;\n\n    this.mb.on('click', e => {\n      fire('restart_idle_timeout');\n      if (e.originalEvent.cancelBubble) {\n        return;\n      }\n      // cancel the previous click handler if it's still pending\n      clearTimeout(this.clickDelayHandler);\n      // if this is a real mouse double-click, we can simply return here\n      if (e.originalEvent.detail >= 2) {\n        return;\n      }\n      const pois = this.mb.queryRenderedFeatures(e.point, { layers: interactiveLayers });\n      // when clicking on a POI, just trigger the action without delay,\n      // as a subsequent double click isn't a problem\n      if (pois[0]) {\n        this.clickOnMap(e.lngLat, pois[0]);\n        return;\n      }\n      this.clickDelayHandler = setTimeout(() => {\n        // for touch UX we have to make sure a double tap zoom hasn't been made in the meantime\n        if (Date.now() - this.lastDoubleTapTimeStamp < this.DOUBLE_TAP_DELAY_MS) {\n          return;\n        }\n        this.clickOnMap(e.lngLat, null);\n      }, this.DOUBLE_TAP_DELAY_MS);\n    });\n\n    // Long touch polyfill (for mobile devices and touch screens)\n    // Custom implementation because the contextmenu event isn't supported by MapBox.\n    // Long touch is initiated on touchstart event, and canceled if a move, gesture or touchend occurs before 500ms.\n    // Sources:\n    // https://stackoverflow.com/a/1943768 (explanation of 500ms delay)\n    // https://stackoverflow.com/a/54746189 (polyfill implementation also using the 500ms delay)\n\n    let longTouchTimeout = null;\n    this.mb.on('touchstart', e => {\n      fire('restart_idle_timeout');\n      if (e.originalEvent.touches.length === 1) {\n        longTouchTimeout = setTimeout(() => {\n          this.clickOnMap(e.lngLat, null, { longTouch: true });\n          this.cancelClickAfterLongTouch = true;\n        }, LONG_TOUCH_DELAY_MS);\n      }\n    });\n\n    const longTouchCancellingEvents = [\n      'touchend',\n      // 'touchcancel', // ignore this event as it's always thrown by Firefox Android\n      // https://bugzilla.mozilla.org/show_bug.cgi?id=1481923\n      // Doesn't seem to change the behavior for other browsers\n      'touchmove',\n      'pointerdrag',\n      'pointermove',\n      'moveend',\n      'gesturestart',\n      'gesturechange',\n      'gestureend',\n    ];\n\n    const cancelLongTouch = e => {\n      if (longTouchTimeout) {\n        clearTimeout(longTouchTimeout);\n        longTouchTimeout = null;\n      }\n\n      if (this.cancelClickAfterLongTouch) {\n        e.originalEvent.preventDefault();\n        this.cancelClickAfterLongTouch = false;\n      }\n    };\n\n    longTouchCancellingEvents.forEach(event => {\n      this.mb.on(event, cancelLongTouch);\n    });\n\n    this.mb.on('dragstart', () => {\n      fire('map_user_interaction');\n    });\n    this.mb.on('pitchstart', () => {\n      fire('map_user_interaction');\n    });\n\n    this.mb.on('moveend', () => {\n      const { lng, lat } = this.mb.getCenter();\n      const zoom = this.mb.getZoom();\n      setLastLocation({ lng, lat, zoom });\n      window.app.updateHash(this.getLocationHash());\n      fire('map_moveend');\n    });\n\n    window.execOnMapLoaded = f => f();\n    fire('map_loaded');\n  });\n\n  listen('fit_map', (item, forceAnimate) => {\n    this.fitMap(item, forceAnimate);\n  });\n\n  listen('ensure_poi_visible', (poi, options) => {\n    this.ensureMarkerIsVisible(poi, options);\n  });\n\n  listen('create_poi_marker', poi => {\n    this.addMarker(poi);\n  });\n\n  listen('clean_marker', () => {\n    this.cleanMarker();\n  });\n\n  listen('save_location', () => {\n    this.saveLocation();\n  });\n\n  listen('restore_location', () => {\n    this.restoreLocation();\n  });\n\n  listen('move_mobile_bottom_ui', bottom => {\n    this.moveMobileBottomUI(bottom);\n  });\n\n  listen('move_mobile_geolocation_button', bottom => {\n    this.moveMobileGeolocationButton(bottom);\n  });\n\n  listen('mobile_geolocation_button_visibility', visible => {\n    this.mobileButtonVisibility('.mapboxgl-ctrl-geolocate', visible);\n  });\n\n  listen('mobile_direction_button_visibility', visible => {\n    this.mobileButtonVisibility('.direction_shortcut', visible);\n  });\n\n  listen('update_map_paddings', () => {\n    this.mb.setPadding(getCurrentMapPaddings());\n  });\n};\n\nScene.prototype.clickOnMap = function (lngLat, clickedFeature, { longTouch = false } = {}) {\n  // Instantiate the place clicked as a PoI\n  const poi = clickedFeature ? new MapPoi(clickedFeature) : new LatLonPoi(lngLat);\n\n  if (document.querySelector('.directions-open')) {\n    // If Direction panel is open, tell it to fill its fields with this PoI\n    fire('set_direction_point', poi);\n  } else if (isMobileDevice() && !clickedFeature && !longTouch) {\n    // On mobile, simple clicks anywhere don't do anything\n    return;\n  } else {\n    // Default case: open the POI panel\n    window.app.navigateTo(`/place/${toUrl(poi)}`, { poi });\n  }\n};\n\nScene.prototype.saveLocation = function () {\n  this.savedLocation = this.getLocationHash();\n};\n\nScene.prototype.restoreLocation = function () {\n  if (this.savedLocation) {\n    const { zoom, lat, lng } = parseMapHash(this.savedLocation);\n    const flyOptions = {\n      center: [lng, lat],\n      zoom,\n      animate: true,\n      screenSpeed: 2,\n    };\n    this.mb.flyTo(flyOptions);\n  }\n};\n\nconst clamp = (min, max, value) => Math.min(max, Math.max(min, value));\n\nScene.prototype.isBBoxInExtendedViewport = function (bbox) {\n  const viewport = this.mb.getBounds();\n\n  const width = viewport.getEast() - viewport.getWest();\n  const height = viewport.getNorth() - viewport.getSouth();\n\n  // Compute extended viewport, with lats between -85 and 85\n  viewport.setNorthEast(\n    new LngLat(viewport.getEast() + width, clamp(-85, 85, viewport.getNorth() + height)).wrap()\n  );\n  viewport.setSouthWest(\n    new LngLat(viewport.getWest() - width, clamp(-85, 85, viewport.getSouth() - height)).wrap()\n  );\n\n  // Check if the bbox overlaps the viewport\n  return (\n    viewport.contains(bbox.getNorthWest()) ||\n    viewport.contains(bbox.getNorthEast()) ||\n    viewport.contains(bbox.getSouthEast()) ||\n    viewport.contains(bbox.getSouthWest())\n  );\n};\n\nScene.prototype.fitBbox = function (bbox, forceAnimate) {\n  // normalise bbox\n  if (bbox instanceof Array) {\n    bbox = new LngLatBounds(bbox);\n  }\n\n  // Animate if the zoom is big enough and if the BBox is (partially or fully) in\n  // the extended viewport.\n  const animate = forceAnimate || (this.mb.getZoom() > 10 && this.isBBoxInExtendedViewport(bbox));\n  this.mb.fitBounds(bbox, { animate });\n};\n\n// Move the map to focus on an item\nScene.prototype.fitMap = function (item, forceAnimate) {\n  // BBox\n  if (item instanceof LngLatBounds || Array.isArray(item)) {\n    this.fitBbox(item, forceAnimate);\n  } else {\n    // PoI\n    if (item.bbox) {\n      // poi Bbox\n      this.fitBbox(item.bbox, forceAnimate);\n    } else {\n      // poi center\n      const flyOptions = {\n        center: item.latLon,\n        zoom: getBestZoom(item),\n        screenSpeed: 1.5,\n        animate: false,\n      };\n\n      if (forceAnimate || (this.mb.getZoom() > 10 && this.isWindowedPoi(item))) {\n        flyOptions.animate = true;\n      }\n      this.mb.flyTo(flyOptions);\n    }\n  }\n};\n\nScene.prototype.ensureMarkerIsVisible = function (poi, options) {\n  if (poi.bbox) {\n    this.fitBbox(poi.bbox);\n    return;\n  }\n  const isMobile = isMobileDevice();\n  if (!options.centerMap) {\n    const isPoiUnderPanel = isPositionUnderUI(this.mb.project(poi.latLon), { isMobile });\n    if (this.isWindowedPoi(poi) && !isPoiUnderPanel) {\n      return;\n    }\n  }\n  this.mb.flyTo({\n    center: poi.latLon,\n    zoom: getBestZoom(poi),\n    maxDuration: 1200,\n  });\n};\n\nScene.prototype.addMarker = function (poi) {\n  const element = createDefaultPin();\n  element.onclick = function (e) {\n    // click event should not be propagated to the map itself;\n    e.stopPropagation();\n  };\n\n  if (this.currentMarker !== null) {\n    this.currentMarker.remove();\n  }\n\n  const marker = new Marker({ element, anchor: 'bottom', offset: [0, -5] })\n    .setLngLat(poi.latLon)\n    .addTo(this.mb);\n  this.currentMarker = marker;\n  return marker;\n};\n\nScene.prototype.cleanMarker = async function () {\n  if (this.currentMarker !== null) {\n    this.currentMarker.remove();\n    this.currentMarker = null;\n  }\n};\n\nScene.prototype.isWindowedPoi = function (poi) {\n  return this.mb.getBounds().contains(new LngLat(poi.latLon.lng, poi.latLon.lat));\n};\n\nScene.prototype.getLocationHash = function () {\n  const { lat, lng } = this.mb.getCenter();\n  return getMapHash(this.mb.getZoom(), lat, lng);\n};\n\nScene.prototype.restoreFromHash = function (hash, options = {}) {\n  const zll = parseMapHash(hash);\n  if (!zll) {\n    return;\n  }\n  const { zoom, lat, lng } = zll;\n  this.mb.flyTo({ zoom, center: [lng, lat], ...options });\n};\n\nScene.prototype.onHashChange = function () {\n  window.onhashchange = () => {\n    this.restoreFromHash(window.location.hash, { animate: false });\n  };\n};\n\nScene.prototype.translateUIControl = function (selector, bottom) {\n  const item = document.querySelector(selector);\n  if (item) {\n    item.style.transform = `translateY(${-bottom}px)`;\n  }\n};\n\nScene.prototype.moveMobileBottomUI = function (bottom = 0) {\n  if (!isMobileDevice() && bottom > 0) {\n    return;\n  }\n  const uiControls = [\n    '.map_control__scale_attribute_container',\n    '.mapboxgl-ctrl-geolocate',\n    '.direction_shortcut',\n  ];\n  uiControls.forEach(uiControl => {\n    this.translateUIControl(uiControl, bottom);\n  });\n};\n\nScene.prototype.moveMobileGeolocationButton = function (bottom = 0) {\n  if (!isMobileDevice() && bottom > 0) {\n    return;\n  }\n  this.translateUIControl('.mapboxgl-ctrl-geolocate', bottom);\n};\n\nScene.prototype.mobileButtonVisibility = function (selector, visible) {\n  if (!isMobileDevice()) {\n    return;\n  }\n  const item = document.querySelector(selector);\n  if (item) {\n    if (visible) {\n      item.classList.remove('hidden');\n    } else {\n      item.classList.add('hidden');\n    }\n  }\n};\n\nlisten('restart_idle_timeout', () => {\n  // Cancel idle status\n  showMobileScale();\n  clearTimeout(MOBILE_IDLE_TIMEOUT);\n\n  // Start a new 2s idle timeout\n  MOBILE_IDLE_TIMEOUT = setTimeout(() => {\n    hideMobileScale();\n  }, MOBILE_IDLE_DELAY_MS);\n});\n\nexport default Scene;\n"],"sourceRoot":""}