{"version":3,"sources":["webpack:///./src/adapters/pois_styles.ts","webpack:///./local_modules/mapbox_style_configure/index.js","webpack:///./src/mapbox/locale.ts","webpack:///./src/components/PoiPopup.jsx","webpack:///./src/adapters/poi_popup.js","webpack:///./src/mapbox/mobile_compass_control.js","webpack:///./src/mapbox/extended_scale_control.js","webpack:///./src/mapbox/extended_attribution_control.js","webpack:///./src/libs/renderStaticReact.js","webpack:///./src/mapbox/extended_geolocate_control.js","webpack:///./src/mapbox/extended_nav_control.js","webpack:///./src/adapters/poi/map_poi.js","webpack:///./src/adapters/scene_config.js","webpack:///./src/panel/direction/RouteLabel/index.jsx","webpack:///./src/adapters/route_styles.js","webpack:///./local_modules/alt-route-labeller/index.js","webpack:///./src/adapters/scene_direction.js","webpack:///./src/adapters/scene_category.js","webpack:///./src/adapters/scene.js"],"names":["module","exports","configure","style","mapStyleConfig","lang","JSON","parse","replace","baseMapUrl","poiMapUrl","spritesUrl","fontsUrl","PoiPopup","poi","useFavorites","isInFavorites","removeFromFavorites","addToFavorites","isDirectionActive","useConfig","enabled","openDirection","Telemetry","sendPoiEvent","window","app","navigateTo","onClickPhoneNumber","source","meta","buildInteractionData","id","template","zone","element","toggleStorePoi","e","preventDefault","isFavorite","stored","fire","WAIT_BEFORE_DISPLAY","WAIT_BEFORE_CLOSE","undefined","prototype","init","map","popupHandle","timeOutHandler","activePoiId","closeTimeoutHandler","listen","isMobileDevice","isTouchEvent","createPJPopup","close","clearTimeout","setTimeout","addListener","layer","on","features","properties","global_id","createOSMPopup","originalEvent","layerPoi","event","ApiPoi","poiApiLoad","simple","showPopup","popupOptions","className","closeButton","maxWidth","offset","anchor","getPopupAnchor","Popup","setLngLat","latLon","setHTML","addTo","popupWrapper","document","querySelector","ReactDOM","render","VERTICAL_OFFSET","HORIZONTAL_OFFSET","canvasWidth","innerWidth","anchorFragments","clientY","push","clientX","join","unmountComponentAtNode","remove","sourceCapabilities","firesTouchEvents","MobileCompassControl","_container","createElement","compassClass","_compass","_createButton","_resetNorthAndTilt","compassIndicatorClass","_compassIndicator","_createIcon","appendChild","_map","textContent","_pitchAndRotateCompassArrow","bind","parentNode","removeChild","navigator","geolocation","getCurrentPosition","position","flyTo","center","coords","longitude","latitude","maximumAge","ariaLabel","fn","a","setAttribute","addEventListener","easeTo","pitch","bearing","getPitch","transform","angle","classList","add","scale","rotation","Math","PI","ExtendedScaleControl","options","container","parentContainer","_onMove","ScaleControl","ExtendedAttributionControl","AttributionControl","reactElement","ReactDOMServer","renderToStaticMarkup","ExtendedGeolocateControl","addOnce","LOCALISE_TRIGGER","_setupUI","cb","_onReady","Geolocation","state","PROMPT","store","openPendingGeolocateModal","supported","_geolocateButton","firstChild","innerHTML","renderStaticReact","error","disabled","GeolocateControl","ExtendedControl","topButtonGroup","bottomButtonGroup","directionShortcutCallback","_zoomInButton","MAP_ZOOM_IN","zoomIn","_zoomOutButton","MAP_ZOOM_OUT","zoomOut","_direction","MAP_ITINERARY","geolocControl","GeolocControl","positionOptions","enableHighAccuracy","trackUserLocation","showAccuracyCircle","onReady","addControl","scaleAttributionContainer","extendedScaleControl","unit","extendedAttributionControl","unListen","MapPoi","feature","subClassName","subclass","name","ll","LngLat","convert","geometry","coordinates","POI_TYPE","Poi","nconf","get","mapStyle","baseUrl","system","sceneConfig","Object","assign","URI","toAbsoluteUrl","location","origin","getStyle","stringify","qwantStyle","getBaseLang","code","PublicTransportIcon","mode","getTransportTypeIcon","PublicTransportStepIcons","route","nonWalkLegs","legs","filter","leg","length","index","RouteLabel","vehicle","isPublicTransport","formatDuration","duration","formatDistance","distance","darkenColor","hex","Color","mix","safeHexColor","charAt","prepareRouteColor","lineColor","outlineColor","getColorExpression","isActive","isOutline","getRouteStyle","type","layout","visibility","paint","setActiveRouteStyle","layerId","setLayoutProperty","setPaintProperty","TOLERANCE","floatEquals","f1","f2","abs","coordEquals","c1","c2","asKey","coord","toFixed","last","array","project","ratio","ls","lineLength","lngLat","getCoord","along","localLineBearing","distinctSegment","coordCounts","adjacentCoordsUsedOnce","forEach","longestDistinctSegment","reduce","longest","current","tmp","lineString","findDistinctSegments","linestrings","featuresCoords","coordAll","Map","concat","set","toSimpleLinestring","allCoordsWithNoDups","noDups","prevCoord","optimizeAnchors","positions","others","slice","splice","othersBearing","getBearingFromOtherPoints","getAnchor","other","avg","value","_index","otherBearing","axis","getLabelPositions","routes","featuresOrGeoms","Array","isArray","lineStrings","segments","createMarker","Marker","createRouteLabel","onclick","getLabelsBbbox","labelPositions","routesBbox","smallScreen","shift","latShift","getNorth","getSouth","lngShift","getEast","getWest","labelsBbbox","LngLatBounds","shiftLabelPosition","labelPosition","extend","lng","lat","SceneDirection","originMarker","cx","draggable","refreshDirection","target","getLngLat","routeMarkers","destinationMarker","routeLabels","fullBbox","mapFeaturesByRoute","iconsBaseUrl","addMapImage","pixelRatio","activeRouteId","reset","displayRoutes","routeId","fitView","setMainRoute","step","computeBBox","highlightStep","unhighlightStep","setOrigin","setDestination","getAllSteps","idx","stepMarker","maneuver","getElement","getAllStops","stop","stopMarker","title","mainRoute","outlineLayerId","moveLayer","routes_layer","updateMarkers","updateRouteLabels","marker","addMarkerSteps","originDestinationCoords","destination","addRouteFeatures","querySelectorAll","routeLabel","dataset","toString","newPoint","LatLonPoi","sourceId","removeLayer","removeSource","featureCollection","normalizeToFeatureCollection","sources","walkFeatures","nonWalkFeatures","data","getDataSources","addSource","layerStyle","outlineLayerStyle","addLayer","getCanvas","cursor","bbox","minX","minY","maxX","maxY","url","loadImage","image","Error","sendOnce","addImage","poisToGeoJSON","pois","poiFeature","poiToGeoJSON","iconName","IconManager","iconClass","SceneCategory","hoveredPoi","hoveredMarker","createPinIcon","disablePointerEvents","selectedPoi","selectedMarker","createMapGLIcon","then","imageData","sourceName","emptyFeatureCollection","promoteId","showNamesWithPins","labelLayerId","FILTERED_POIS_LABEL_STYLES","layers","pinLayerId","FILTERED_POIS_PIN_STYLES","layerName","handleLayerMarkerClick","handleLayerMarkerMouseOver","handleLayerMarkerMouseLeave","mapMouseEvent","find","p","poiFilters","category","toUrl","centerMap","selectPoiMarker","stopPropagation","getPointedPoi","selectPoi","highlightPoiMarker","setOsmPoisVisibility","getSource","setData","displayed","constants","pois_layers","setFeatureState","highlight","setPoiFeatureState","hovered","selected","initActiveStateMarkers","initDynamicPoiLayers","addCategoryMarkers","removeCategoryMarkers","LONG_TOUCH_DELAY_MS","MOBILE_IDLE_DELAY_MS","MOBILE_IDLE_TIMEOUT","Scene","currentMarker","popup","savedLocation","getPoiView","zoom","getBestZoom","bounds","hideMobileScale","item","showMobileScale","getMapInitOptions","locationHash","parseBboxString","console","hotLoadPoi","lastLocation","getLastLocation","initialBbox","fitBoundsOptions","maxZoom","mapConfig","initMapBox","times","Date","now","compilationHash","__config","setRTLTextPlugin","send","mb","attributionControl","hash","locale","setPadding","getCurrentMapPaddings","interactiveLayers","DOUBLE_TAP_DELAY_MS","lastDoubleTapTimeStamp","lastTouchEndTimeStamp","timeStamp","onHashChange","interactiveLayer","setPoiHoverStyle","hover","clickDelayHandler","cancelBubble","detail","queryRenderedFeatures","point","clickOnMap","longTouchTimeout","touches","longTouch","cancelClickAfterLongTouch","longTouchCancellingEvents","cancelLongTouch","getCenter","getZoom","setLastLocation","updateHash","getLocationHash","execOnMapLoaded","f","forceAnimate","fitMap","ensureMarkerIsVisible","addMarker","cleanMarker","saveLocation","restoreLocation","bottom","moveMobileBottomUI","moveMobileGeolocationButton","visible","mobileButtonVisibility","clickedFeature","parseMapHash","flyOptions","animate","screenSpeed","clamp","min","max","isBBoxInExtendedViewport","viewport","getBounds","width","height","setNorthEast","wrap","setSouthWest","contains","getNorthWest","getNorthEast","getSouthEast","getSouthWest","fitBbox","fitBounds","isWindowedPoi","isMobile","isPoiUnderPanel","isPositionUnderUI","maxDuration","createDefaultPin","getMapHash","restoreFromHash","zll","onhashchange","translateUIControl","selector","uiControls","uiControl"],"mappings":"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","file":"map-9e508141e991c37b2ffe.bundle.js","sourcesContent":["\"use strict\";\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.setPoiHoverStyle = exports.FILTERED_POIS_LABEL_STYLES = exports.FILTERED_POIS_PIN_STYLES = void 0;\nvar colors_1 = require(\"src/libs/colors\");\nexports.FILTERED_POIS_PIN_STYLES = {\n    type: 'symbol',\n    layout: {\n        'icon-image': ['concat', 'pin-', ['get', 'iconName']],\n        'icon-allow-overlap': true,\n        'icon-ignore-placement': false,\n        'icon-padding': 0,\n        'icon-anchor': 'bottom',\n    },\n    paint: {\n        'icon-opacity': [\n            'case',\n            ['==', ['feature-state', 'selected'], true],\n            0,\n            ['==', ['feature-state', 'hovered'], true],\n            0,\n            1,\n        ],\n    },\n};\nexports.FILTERED_POIS_LABEL_STYLES = {\n    type: 'symbol',\n    layout: {\n        'text-font': ['Noto Sans Bold'],\n        'text-size': 10,\n        'text-field': ['get', 'name'],\n        'text-allow-overlap': false,\n        'text-ignore-placement': false,\n        'text-optional': true,\n        'text-variable-anchor': ['top', 'bottom-left', 'bottom-right'],\n        'text-offset': [1.5, 0.5],\n        'text-justify': 'auto',\n    },\n    paint: {\n        'text-color': ['case', ['==', ['feature-state', 'selected'], true], colors_1.RED_DARKER, colors_1.GREY_BLACK],\n        'text-halo-color': 'white',\n        'text-halo-width': 1,\n        'text-translate': [0, -2],\n    },\n};\nvar setPoiHoverStyle = function (map, layer) {\n    if (!map.getPaintProperty) {\n        // @MAPBOX: This method isn't implemented by the Mapbox-GL mock\n        return;\n    }\n    var textColorProperty = map.getPaintProperty(layer, 'text-color');\n    map.setPaintProperty(layer, 'text-color', ['case', ['to-boolean', ['feature-state', 'hover']], colors_1.ACTION_BLUE_BASE, textColorProperty], { validate: false });\n};\nexports.setPoiHoverStyle = setPoiHoverStyle;\n","module.exports = function configure(style, mapStyleConfig, lang) {\n  return JSON.parse(style\n    .replace(/\\{locale\\}/g, lang)\n    .replace('\"{tileserver_base}\"', mapStyleConfig.baseMapUrl)\n    .replace('\"{tileserver_poi}\"', mapStyleConfig.poiMapUrl)\n    .replace('{spriteserver}', mapStyleConfig.spritesUrl)\n    .replace('{fontserver}', mapStyleConfig.fontsUrl)\n  )\n}\n","\"use strict\";\n/* global _ */\nObject.defineProperty(exports, \"__esModule\", { value: true });\nvar defaultLocale = {\n    'GeolocateControl.FindMyLocation': _('My location', 'mapbox'),\n};\nexports.default = defaultLocale;\n","import React from 'react';\nimport PoiItem from './PoiItem';\nimport { fire } from 'src/libs/customEvents';\nimport ActionButtons from '../panel/poi/ActionButtons';\nimport Telemetry from '../libs/telemetry';\nimport { useConfig, useFavorites } from '../hooks';\n\nconst PoiPopup = ({ poi }) => {\n  const { isInFavorites, removeFromFavorites, addToFavorites } = useFavorites();\n  const isDirectionActive = useConfig('direction').enabled;\n\n  const openDirection = () => {\n    Telemetry.sendPoiEvent(poi, 'itinerary');\n    window.app.navigateTo('/routes/', { poi });\n  };\n\n  const onClickPhoneNumber = () => {\n    const source = poi.meta && poi.meta.source;\n    if (source) {\n      Telemetry.sendPoiEvent(\n        poi,\n        'phone',\n        Telemetry.buildInteractionData({\n          id: poi.id,\n          source,\n          template: 'single',\n          zone: 'detail',\n          element: 'phone',\n        })\n      );\n    }\n  };\n\n  const toggleStorePoi = e => {\n    e?.preventDefault();\n    const isFavorite = isInFavorites(poi);\n    Telemetry.sendPoiEvent(poi, 'favorite', { stored: !isFavorite });\n    if (isFavorite) {\n      removeFromFavorites(poi);\n    } else {\n      addToFavorites(poi);\n    }\n  };\n\n  return (\n    <div\n      className=\"poi_popup\"\n      onMouseEnter={() => {\n        fire('stop_close_popup_timeout');\n      }}\n      onMouseLeave={() => {\n        fire('close_popup');\n      }}\n    >\n      <div className=\"u-mb-s\">\n        <PoiItem poi={poi} withOpeningHours withImage inList />\n      </div>\n      <ActionButtons\n        poi={poi}\n        isDirectionActive={isDirectionActive}\n        openDirection={openDirection}\n        onClickPhoneNumber={onClickPhoneNumber}\n        isPoiInFavorite={isInFavorites(poi)}\n        toggleStorePoi={toggleStorePoi}\n      />\n    </div>\n  );\n};\n\nexport default PoiPopup;\n","import React from 'react';\nimport ReactDOM from 'react-dom';\nimport { Popup } from 'mapbox-gl--ENV';\nimport ApiPoi from './poi/idunn_poi';\nimport { isMobileDevice } from 'src/libs/device';\nimport ReactPoiPopup from 'src/components/PoiPopup';\nimport { fire, listen } from 'src/libs/customEvents';\n\nconst WAIT_BEFORE_DISPLAY = 350;\nconst WAIT_BEFORE_CLOSE = 350;\n\nfunction PoiPopup() {\n  return undefined;\n}\n\nPoiPopup.prototype.init = function (map) {\n  this.map = map;\n  this.popupHandle = null;\n  this.timeOutHandler = null;\n  this.activePoiId = null;\n  this.closeTimeoutHandler = null;\n\n  listen('open_popup', (poi, e) => {\n    if (isMobileDevice() || isTouchEvent(e)) {\n      return;\n    }\n    this.createPJPopup(poi, e);\n    fire('stop_close_popup_timeout');\n  });\n  listen('close_popup', () => this.close());\n  listen('clean_marker', () => {\n    this.close();\n    this.activePoiId = null;\n  });\n\n  listen('stop_close_popup_timeout', () => clearTimeout(this.closeTimeoutHandler));\n  listen('start_close_popup_timeout', () => {\n    clearTimeout(this.closeTimeoutHandler);\n    this.closeTimeoutHandler = setTimeout(() => {\n      fire('close_popup');\n    }, WAIT_BEFORE_CLOSE);\n  });\n};\n\nPoiPopup.prototype.addListener = function (layer) {\n  this.map.on('mouseenter', layer, e => {\n    if (isMobileDevice() || isTouchEvent(e)) {\n      return;\n    }\n    this.timeOutHandler = setTimeout(() => {\n      const poi = e.features[0];\n      if (this.activePoiId === poi.properties.global_id) {\n        return;\n      }\n      this.createOSMPopup(poi, e.originalEvent);\n    }, WAIT_BEFORE_DISPLAY);\n  });\n\n  this.map.on('click', () => {\n    this.close();\n  });\n\n  this.map.on('mouseleave', layer, async () => {\n    clearTimeout(this.timeOutHandler);\n    fire('start_close_popup_timeout');\n  });\n};\n\nPoiPopup.prototype.createOSMPopup = async function (layerPoi, event) {\n  const poi = await ApiPoi.poiApiLoad({ id: layerPoi.properties.global_id }, { simple: true });\n  if (poi) {\n    this.showPopup(poi, event);\n  }\n};\n\nPoiPopup.prototype.createPJPopup = function (poi, event) {\n  if (poi) {\n    this.showPopup(poi, event);\n  }\n};\n\nPoiPopup.prototype.showPopup = function (poi, event) {\n  this.close();\n\n  const popupOptions = {\n    className: 'poi_popup__container',\n    closeButton: false,\n    maxWidth: 'none',\n    offset: 18, //px,\n    anchor: this.getPopupAnchor(event),\n  };\n\n  this.popupHandle = new Popup(popupOptions)\n    .setLngLat(poi.latLon)\n    .setHTML('<div class=\"poi_popup__wrapper\"/></div>')\n    .addTo(this.map);\n\n  const popupWrapper = document.querySelector('.poi_popup__wrapper');\n  if (popupWrapper) {\n    ReactDOM.render(<ReactPoiPopup poi={poi} />, popupWrapper);\n  }\n};\n\nPoiPopup.prototype.getPopupAnchor = function (event) {\n  const VERTICAL_OFFSET = 250;\n  const HORIZONTAL_OFFSET = 300;\n  const canvasWidth = window.innerWidth;\n  const anchorFragments = [];\n\n  if (event) {\n    if (event.clientY > VERTICAL_OFFSET) {\n      anchorFragments.push('bottom');\n    } else {\n      anchorFragments.push('top');\n    }\n\n    if (event.clientX < canvasWidth - HORIZONTAL_OFFSET) {\n      anchorFragments.push('left');\n    } else {\n      anchorFragments.push('right');\n    }\n  } else {\n    anchorFragments.push('bottom');\n    anchorFragments.push('left');\n  }\n\n  return anchorFragments.join('-');\n};\n\nPoiPopup.prototype.close = function () {\n  if (this.popupHandle) {\n    fire('stop_close_popup_timeout');\n    const popupWrapper = document.querySelector('.poi_popup__wrapper');\n    if (popupWrapper) {\n      ReactDOM.unmountComponentAtNode(popupWrapper);\n    }\n    this.popupHandle.remove();\n    this.popupHandle = null;\n  }\n};\n\n/* private */\nfunction isTouchEvent(event) {\n  if (event && event.originalEvent && event.originalEvent.sourceCapabilities) {\n    return event.originalEvent.sourceCapabilities.firesTouchEvents === true;\n  }\n  return false;\n}\n\nexport default PoiPopup;\n","export default class MobileCompassControl {\n  constructor() {\n    this._container = document.createElement('div');\n    const compassClass = 'map_control_group__button__compass--mobile';\n    this._compass = this._createButton(compassClass, 'Reset North', () => {\n      this._resetNorthAndTilt();\n    });\n\n    const compassIndicatorClass = 'map_control__compass__icon map_control__compass__icon--mobile';\n    this._compassIndicator = this._createIcon(compassIndicatorClass);\n    this._compass.appendChild(this._compassIndicator);\n  }\n\n  onAdd(map) {\n    this._map = map;\n    this._container.className = 'map_control_group';\n    this._container.textContent = '';\n    this._container.appendChild(this._compass);\n    const _pitchAndRotateCompassArrow = this._pitchAndRotateCompassArrow.bind(this);\n\n    _pitchAndRotateCompassArrow();\n\n    this._map.on('rotate', _pitchAndRotateCompassArrow);\n    this._map.on('pitch', _pitchAndRotateCompassArrow);\n\n    return this._container;\n  }\n\n  onRemove() {\n    this._container.parentNode.removeChild(this._container);\n    this._map = undefined;\n  }\n\n  _geolocate() {\n    navigator.geolocation.getCurrentPosition(\n      position => {\n        this._map.flyTo({ center: [position.coords.longitude, position.coords.latitude] });\n      },\n      () => undefined,\n      { maximumAge: 10000 }\n    );\n  }\n\n  _createButton(className, ariaLabel, fn) {\n    const a = document.createElement('button');\n    a.setAttribute('class', className);\n    a.setAttribute('aria-label', ariaLabel);\n    a.addEventListener('click', fn);\n    this._container.appendChild(a);\n    return a;\n  }\n\n  _createIcon(className) {\n    const a = document.createElement('span');\n    a.setAttribute('class', className);\n    return a;\n  }\n\n  _resetNorthAndTilt() {\n    this._map.easeTo({ pitch: 0, bearing: 0 });\n  }\n\n  _pitchAndRotateCompassArrow() {\n    if (this._map.getPitch() === 0 && this._map.transform.angle === 0) {\n      this._compass.classList.add('compass-origin');\n    } else {\n      this._compass.classList.remove('compass-origin');\n    }\n    const scale = 1 - this._map.getPitch() / 110;\n    const rotation = this._map.transform.angle * (180 / Math.PI);\n    this._compassIndicator.style.transform = `scale(1, ${scale}) rotate(${rotation}deg)`;\n  }\n}\n","import { ScaleControl } from 'mapbox-gl--ENV';\n\n/**\n * Override default control to pass a container\n * in constructor and register a onReady cb\n */\nexport default class ExtendedScaleControl extends ScaleControl {\n  constructor(options, container) {\n    super(options);\n    this.parentContainer = container;\n  }\n\n  onAdd(map) {\n    this._map = map;\n    this._container = document.createElement('div');\n    this._container.className = 'mapboxgl-ctrl mapboxgl-ctrl-scale map_control__scale';\n\n    this.parentContainer.appendChild(this._container);\n\n    this._map.on('move', this._onMove);\n    super._onMove();\n\n    return this.parentContainer;\n  }\n}\n","import { AttributionControl } from 'mapbox-gl--ENV';\n\n/**\n * Override default control to pass a container\n * in constructor and register a onReady cb\n */\nexport default class ExtendedAttributionControl extends AttributionControl {\n  constructor(options, container) {\n    super(options);\n    this.parentContainer = container;\n  }\n\n  onAdd(map) {\n    const container = super.onAdd(map);\n    if (container) {\n      this.parentContainer.appendChild(container);\n    }\n    return this.parentContainer;\n  }\n}\n","import ReactDOMServer from 'react-dom/server';\n\nexport default reactElement => ReactDOMServer.renderToStaticMarkup(reactElement);\n","import React from 'react';\nimport * as Geolocation from '../libs/geolocation';\nimport Telemetry from '../libs/telemetry';\nimport { openPendingGeolocateModal } from 'src/modals/GeolocationModal';\nimport * as store from 'src/adapters/store';\nimport renderStaticReact from 'src/libs/renderStaticReact';\nimport { IconGeoloc } from 'src/components/ui/icons';\nimport { isMobileDevice } from 'src/libs/device';\n\nimport { GeolocateControl } from 'mapbox-gl--ENV';\n\n/**\n * Override default GeolocateControl\n */\n\nexport default class ExtendedGeolocateControl extends GeolocateControl {\n  constructor(options, container) {\n    super(options);\n    this._container = container;\n    this.on('trackuserlocationstart', () => {\n      Telemetry.addOnce(Telemetry.LOCALISE_TRIGGER);\n    });\n  }\n\n  onAdd(map) {\n    this._map = map;\n    this._setupUI();\n    return this._container;\n  }\n\n  onReady(cb) {\n    this._onReady = cb;\n  }\n\n  async trigger() {\n    const state = await Geolocation.getGeolocationPermission();\n    if (\n      state === Geolocation.geolocationPermissions.PROMPT &&\n      !store.get('has_geolocate_modal_opened_once')\n    ) {\n      await openPendingGeolocateModal();\n      store.set('has_geolocate_modal_opened_once', true);\n    }\n    super.trigger();\n  }\n\n  _setupUI(supported) {\n    super._setupUI(supported);\n    if (this._geolocateButton?.firstChild) {\n      this._geolocateButton.firstChild.innerHTML = renderStaticReact(\n        <IconGeoloc fill=\"currentColor\" width={isMobileDevice() ? 24 : 16} />\n      );\n    }\n    this._onReady();\n  }\n\n  _onError(error) {\n    Geolocation.handleError(error);\n    super._onError(error);\n    // MapboxGL implementation disables the button after an error,\n    // but we won't the user to always have feedback with relevant links\n    // so override this behavior\n    this._geolocateButton.disabled = false;\n  }\n}\n","import React from 'react';\nimport ExtendedScaleControl from './extended_scale_control';\nimport ExtendedAttributionControl from './extended_attribution_control';\nimport GeolocControl from './extended_geolocate_control';\nimport Telemetry from 'src/libs/telemetry';\nimport { listen, unListen } from '../libs/customEvents';\nimport renderStaticReact from 'src/libs/renderStaticReact';\nimport { IconPlus, IconMinus } from 'src/components/ui/icons';\n\nexport default class ExtendedControl {\n  constructor() {\n    this._container = document.createElement('div');\n    this.topButtonGroup = document.createElement('div');\n    this.bottomButtonGroup = document.createElement('div');\n\n    // Store a callback to trigger when direction shortcut is clicked.\n    // if no callback is registered, then the default action will be executed\n    // (navigate to /routes)\n    this.directionShortcutCallback = null;\n    listen('set_direction_shortcut_callback', cb => (this.directionShortcutCallback = cb));\n\n    this._zoomInButton = this._createButton(\n      'map_control_group__button__zoom map-button--zoomIn',\n      'Zoom +',\n      () => {\n        Telemetry.add(Telemetry.MAP_ZOOM_IN);\n        this._map.zoomIn();\n      }\n    );\n    this._zoomInButton.innerHTML = renderStaticReact(<IconPlus fill=\"currentColor\" width={16} />);\n\n    this._zoomOutButton = this._createButton(\n      'map_control_group__button__zoom map-button--zoomOut',\n      'Zoom -',\n      () => {\n        Telemetry.add(Telemetry.MAP_ZOOM_OUT);\n        this._map.zoomOut();\n      }\n    );\n    this._zoomOutButton.innerHTML = renderStaticReact(<IconMinus fill=\"currentColor\" width={16} />);\n\n    const compassClass = 'map_control_group__button__compass';\n    this._compass = this._createButton(compassClass, 'Reset North', () => {\n      this._resetNorthAndTilt();\n    });\n    this._direction = this._createButton('direction_shortcut hidden', 'direction', () => {\n      Telemetry.add(Telemetry.MAP_ITINERARY);\n      this.directionShortcutCallback\n        ? this.directionShortcutCallback()\n        : window.app.navigateTo('/routes'); // default action, if no cb has been set\n    });\n\n    this._compassIndicator = this._createIcon('map_control__compass__icon');\n    this._compass.appendChild(this._compassIndicator);\n  }\n\n  onAdd(map) {\n    this._map = map;\n    this.topButtonGroup.className = 'map_control_group';\n    this.topButtonGroup.textContent = '';\n    this.bottomButtonGroup.className = 'map_control_group map_bottom_button_group mapboxgl-ctrl';\n    this.bottomButtonGroup.textContent = '';\n\n    const geolocControl = new GeolocControl(\n      {\n        positionOptions: {\n          enableHighAccuracy: true,\n        },\n        trackUserLocation: true,\n        showAccuracyCircle: false,\n      },\n      this.bottomButtonGroup\n    );\n\n    this.topButtonGroup.appendChild(this._compass);\n    this.topButtonGroup.appendChild(this._direction);\n\n    geolocControl.onReady(() => {\n      this.bottomButtonGroup.appendChild(this._zoomInButton);\n      this.bottomButtonGroup.appendChild(this._zoomOutButton);\n    });\n\n    this._map.addControl(geolocControl);\n\n    const _pitchAndRotateCompassArrow = this._pitchAndRotateCompassArrow.bind(this);\n\n    _pitchAndRotateCompassArrow();\n\n    this._map.on('rotate', _pitchAndRotateCompassArrow);\n    this._map.on('pitch', _pitchAndRotateCompassArrow);\n\n    this.scaleAttributionContainer = document.createElement('div');\n    this.scaleAttributionContainer.className = 'map_control__scale_attribute_container';\n    this._container.appendChild(this.scaleAttributionContainer);\n\n    const extendedScaleControl = new ExtendedScaleControl(\n      {\n        unit: 'metric',\n      },\n      this.scaleAttributionContainer\n    );\n\n    const extendedAttributionControl = new ExtendedAttributionControl(\n      {},\n      this.scaleAttributionContainer\n    );\n    this._container.appendChild(this.topButtonGroup);\n    this._container.appendChild(this.bottomButtonGroup);\n\n    this._container.appendChild(this.scaleAttributionContainer);\n    this._map.addControl(extendedScaleControl, 'bottom-right');\n    this._map.addControl(extendedAttributionControl, 'bottom-right');\n    return this._container;\n  }\n\n  onRemove() {\n    this._container.parentNode.removeChild(this._container);\n    this._map = undefined;\n    unListen('set_direction_shortcut_callback');\n  }\n\n  _createButton(className, ariaLabel, fn) {\n    const a = document.createElement('button');\n    a.setAttribute('class', className);\n    a.setAttribute('aria-label', ariaLabel);\n    a.setAttribute('title', ariaLabel);\n    a.addEventListener('click', fn);\n    return a;\n  }\n\n  _createIcon(className) {\n    const a = document.createElement('span');\n    a.setAttribute('class', className);\n    return a;\n  }\n\n  _resetNorthAndTilt() {\n    this._map.easeTo({ pitch: 0, bearing: 0 });\n  }\n\n  _pitchAndRotateCompassArrow() {\n    if (this._map.getPitch() === 0 && this._map.transform.angle === 0) {\n      this._compass.classList.add('compass-origin');\n    } else {\n      this._compass.classList.remove('compass-origin');\n    }\n    const scale = 1 - this._map.getPitch() / 110;\n    const rotation = this._map.transform.angle * (180 / Math.PI);\n    this._compassIndicator.style.transform = `scale(1, ${scale}) rotate(${rotation}deg)`;\n  }\n}\n","import { LngLat } from 'mapbox-gl--ENV';\nimport Poi, { POI_TYPE } from './poi';\n\nexport default class MapPoi extends Poi {\n  constructor(feature) {\n    const { global_id, ['class']: className, subclass: subClassName, name } = feature.properties;\n    const ll = LngLat.convert(feature.geometry.coordinates);\n    super(global_id || feature.id, name, POI_TYPE, ll, className, subClassName);\n  }\n}\n","import nconf from '@qwant/nconf-getter';\nimport configure from '@qwant/mapbox_style_configure';\nimport URI from '@qwant/uri';\nimport qwantStyle from '@qwant/qwant-basic-gl-style/style.json';\n\nconst mapStyleConfig = nconf.get().mapStyle;\nconst baseUrl = nconf.get().system.baseUrl;\n\nfunction sceneConfig() {\n  return Object.assign(mapStyleConfig, {\n    spritesUrl: URI.toAbsoluteUrl(location.origin, baseUrl, mapStyleConfig.spritesUrl),\n    fontsUrl: URI.toAbsoluteUrl(location.origin, baseUrl, mapStyleConfig.fontsUrl),\n  });\n}\n\nexport default function getStyle() {\n  return configure(JSON.stringify(qwantStyle), sceneConfig(), window.getBaseLang().code);\n}\n","import React from 'react';\nimport { getTransportTypeIcon, formatDistance, formatDuration } from 'src/libs/route_utils';\nimport VehicleIcon from '../VehicleIcon';\n\nconst PublicTransportIcon = ({ mode }) => (\n  <div\n    className={`publicTransportLabelItem roadmapIcon roadmapIcon--${getTransportTypeIcon({\n      mode,\n    })}`}\n  />\n);\n\nconst PublicTransportStepIcons = ({ route }) => {\n  const nonWalkLegs = route.legs.filter(leg => leg.mode !== 'WALK');\n\n  if (nonWalkLegs.length <= 3) {\n    return (\n      <div>\n        {nonWalkLegs.map((leg, index) => (\n          <PublicTransportIcon key={index} mode={leg.mode} />\n        ))}\n      </div>\n    );\n  }\n\n  return (\n    <div>\n      <PublicTransportIcon mode={nonWalkLegs[0].mode} />\n      <div className=\"publicTransportLabelItem roadmapIcon u-text--caption roadmapIcon--inbetween\">\n        <div>+{nonWalkLegs.length - 2}</div>\n      </div>\n      <PublicTransportIcon mode={nonWalkLegs[nonWalkLegs.length - 1].mode} />\n    </div>\n  );\n};\n\nconst RouteLabel = ({ route, vehicle, anchor }) => {\n  const isPublicTransport = vehicle === 'publicTransport';\n  return (\n    <div data-id={route.id} className={`routeLabel routeLabel--${anchor} routeLabel--${vehicle}`}>\n      {isPublicTransport ? (\n        <PublicTransportStepIcons route={route} />\n      ) : (\n        <div className=\"routeLabel-vehicleIcon\">\n          <VehicleIcon vehicle={vehicle} fill=\"currentColor\" width={24} />\n        </div>\n      )}\n      <div>\n        <div className=\"routeLabel-duration\">{formatDuration(route.duration)}</div>\n        {!isPublicTransport && (\n          <div className=\"routeLabel-distance\">{formatDistance(route.distance)}</div>\n        )}\n      </div>\n    </div>\n  );\n};\n\nexport default RouteLabel;\n","import Color from 'color';\n\nconst darkenColor = hex => Color(hex).mix(Color('black'), 0.33).hex();\nconst safeHexColor = hex => (hex.charAt(0) === '#' ? hex : `#${hex}`);\n\nexport function prepareRouteColor(feature) {\n  const lineColor = feature.properties?.lineColor;\n  return {\n    ...feature,\n    properties: {\n      ...feature.properties,\n      lineColor: lineColor ? safeHexColor(lineColor) : '#57C78E',\n      outlineColor: lineColor ? darkenColor(safeHexColor(lineColor)) : '#297A52',\n    },\n  };\n}\n\nfunction getColorExpression(isActive, isOutline) {\n  if (isActive) {\n    return isOutline ? ['get', 'outlineColor'] : ['get', 'lineColor'];\n  }\n  return isOutline ? '#676E79' : '#C7CBD1';\n}\n\nexport function getRouteStyle(vehicle, isActive, isOutline) {\n  if (vehicle === 'walking') {\n    return {\n      type: 'symbol',\n      layout: {\n        'icon-image': isActive ? 'walking_bullet_active' : 'walking_bullet_inactive',\n        'symbol-placement': 'line',\n        'symbol-spacing': 12,\n        'icon-ignore-placement': true,\n        'icon-allow-overlap': true,\n        'symbol-avoid-edges': true,\n      },\n    };\n  }\n\n  return {\n    type: 'line',\n    layout: {\n      'line-join': 'round',\n      'line-cap': 'round',\n      visibility: 'visible',\n    },\n    paint: {\n      'line-color': getColorExpression(isActive, isOutline),\n      'line-color-transition': { duration: 0 },\n      'line-width': isOutline ? 9 : 5,\n    },\n  };\n}\n\nexport function setActiveRouteStyle(map, layerId, vehicle, isActive, isOutline) {\n  if (vehicle === 'walking') {\n    map.setLayoutProperty(\n      layerId,\n      'icon-image',\n      isActive ? 'walking_bullet_active' : 'walking_bullet_inactive'\n    );\n  } else {\n    map.setPaintProperty(layerId, 'line-color', getColorExpression(isActive, isOutline));\n  }\n}\n","// Alt-route-labeller\n// Original author: Benjamin Becquet\n// Forked from: https://www.npmjs.com/package/alt-route-labeller\n// Altered distinctSegment() to ensure the filtered array passed to lineString() has at least 2 items\n\nimport { coordAll } from '@turf/meta';\nimport { lineString } from '@turf/helpers';\nimport { getCoord } from '@turf/invariant';\nimport along from '@turf/along';\nimport lineLength from '@turf/length';\nimport bearing from '@turf/bearing';\n\nconst TOLERANCE = 0.000001;\nconst floatEquals = (f1, f2) => Math.abs(f1 - f2) < TOLERANCE;\nconst coordEquals = (c1 = [], c2 = []) => floatEquals(c1[0], c2[0]) && floatEquals(c1[1], c2[1]);\nconst asKey = coord => `${coord[0].toFixed(6)},${coord[1].toFixed(6)}`;\nconst last = (array = []) => array[array.length - 1];\n\n// find the point at the given distance ratio on the linestring\nconst project = ratio => ls => {\n  const length = lineLength(ls);\n  const lngLat = getCoord(along(ls, length * ratio));\n  // keep the local bearing of the line to later choose an anchor minimizing the portion of line covered.\n  const localLineBearing = bearing(\n    along(ls, length * (ratio - 0.1)),\n    along(ls, length * (ratio + 0.1))\n  );\n\n  return { lngLat, localLineBearing };\n};\n\nfunction distinctSegment(coordinates, coordCounts) {\n  const adjacentCoordsUsedOnce = [[]];\n  coordinates.forEach(coord => {\n    if (coordCounts.get(asKey(coord)) > 1) {\n      adjacentCoordsUsedOnce.push([]);\n    } else {\n      last(adjacentCoordsUsedOnce).push(coord);\n    }\n  });\n  const longestDistinctSegment = adjacentCoordsUsedOnce\n    .filter(a => a.length > 0)\n    .reduce((longest, current) => (current.length > longest.length ? current : longest), []);\n\n  const tmp = longestDistinctSegment.length === 0 ? coordinates : longestDistinctSegment;\n\n  if (tmp.length === 1) tmp[1] = tmp[0];\n\n  return lineString(tmp);\n}\n\n// extract the longest segment of each linestring\n// whose coordinates don't overlap with another feature\nexport function findDistinctSegments(linestrings) {\n  if (linestrings.length < 2) {\n    return linestrings;\n  }\n  // extract raw coordinates\n  const featuresCoords = linestrings.map(coordAll);\n  // count occurences of each coordinate accross all features\n  const coordCounts = new Map();\n  [].concat(...featuresCoords).forEach(coord => {\n    coordCounts.set(asKey(coord), (coordCounts.get(asKey(coord)) || 0) + 1);\n  });\n  return featuresCoords.map(coordinates => distinctSegment(coordinates, coordCounts));\n}\n\nfunction toSimpleLinestring(feature) {\n  const allCoordsWithNoDups = coordAll(feature).reduce((noDups, coord) => {\n    const prevCoord = last(noDups);\n    if (!prevCoord || !coordEquals(prevCoord, coord)) {\n      noDups.push(coord);\n    }\n    return noDups;\n  }, []);\n  return lineString(allCoordsWithNoDups);\n}\n\n// Reduce possibilities of collision by chosing anchors so that labels repulse each other\nfunction optimizeAnchors(positions) {\n  return positions.map((position, index) => {\n    const others = positions.slice();\n    others.splice(index, 1);\n    const othersBearing = getBearingFromOtherPoints(position, others);\n    return {\n      lngLat: position.lngLat,\n      anchor: getAnchor(position, othersBearing),\n    };\n  });\n}\n\nfunction getBearingFromOtherPoints(position, others) {\n  return (\n    others\n      .map(other => bearing(other.lngLat, position.lngLat))\n      .reduce((avg, value, _index, { length }) => avg + value / length, 0) || // mean\n    0\n  );\n}\n\nfunction getAnchor(position, otherBearing) {\n  const axis =\n    Math.abs(position.localLineBearing) < 45 || Math.abs(position.localLineBearing) > 135\n      ? 'vertical'\n      : 'horizontal';\n\n  if (axis === 'vertical') {\n    return otherBearing > 0 ? 'left' : 'right';\n  }\n  return Math.abs(otherBearing) < 90 ? 'bottom' : 'top';\n}\n\n// routes can be a FeatureCollection or an array of Feature or Geometry\nexport function getLabelPositions(routes = []) {\n  const featuresOrGeoms = Array.isArray(routes) ? routes : routes.features;\n  const lineStrings = featuresOrGeoms.map(toSimpleLinestring);\n  const segments = findDistinctSegments(lineStrings);\n  const positions = segments.map(project(0.5));\n  return optimizeAnchors(positions);\n}\n","import React from 'react';\nimport RouteLabel from 'src/panel/direction/RouteLabel';\nimport { Marker, LngLatBounds } from 'mapbox-gl--ENV';\nimport bbox from '@turf/bbox';\nimport { normalizeToFeatureCollection } from 'src/libs/geojson';\nimport { map } from '../../config/constants.yml';\nimport LatLonPoi from '../adapters/poi/latlon_poi';\nimport { prepareRouteColor, getRouteStyle, setActiveRouteStyle } from './route_styles';\nimport { getAllSteps, getAllStops, originDestinationCoords } from 'src/libs/route_utils';\nimport Error from '../adapters/error';\nimport nconf from '@qwant/nconf-getter';\nimport { fire, listen } from 'src/libs/customEvents';\nimport { getLabelPositions } from '/local_modules/alt-route-labeller';\nimport { isMobileDevice } from 'src/libs/device';\nimport renderStaticReact from 'src/libs/renderStaticReact';\nimport cx from 'classnames';\n\nconst createMarker = (lngLat, className = '', options = {}) => {\n  const element = document.createElement('div');\n  element.className = className;\n  return new Marker({ ...options, element }).setLngLat(lngLat);\n};\n\nconst createRouteLabel = (route, vehicle, { lngLat, anchor }) => {\n  const element = document.createElement('div');\n  element.innerHTML = renderStaticReact(\n    <RouteLabel route={route} vehicle={vehicle} anchor={anchor} />\n  );\n  element.className = 'routeLabel-marker';\n  element.onclick = () => {\n    fire('select_road_map', route.id);\n  };\n  return new Marker({ element, anchor }).setLngLat(lngLat);\n};\n\nconst getLabelsBbbox = (labelPositions, routesBbox) => {\n  const smallScreen = isMobileDevice();\n  const shift = {\n    latShift: (routesBbox.getNorth() - routesBbox.getSouth()) / (smallScreen ? 5 : 10),\n    lngShift: (routesBbox.getEast() - routesBbox.getWest()) / (smallScreen ? 3 : 10),\n  };\n  const labelsBbbox = new LngLatBounds();\n  labelPositions.map(shiftLabelPosition(shift)).forEach(labelPosition => {\n    labelsBbbox.extend(labelPosition);\n  });\n  return labelsBbbox;\n};\n\nconst shiftLabelPosition =\n  ({ lngShift, latShift }) =>\n  ({ lngLat, anchor }) => {\n    let [lng, lat] = lngLat;\n    if (anchor === 'top') {\n      lat -= latShift;\n    } else if (anchor === 'bottom') {\n      lat += latShift;\n    } else if (anchor === 'left') {\n      lng += lngShift;\n    } else if (anchor === 'right') {\n      lng -= lngShift;\n    }\n    return [lng, lat];\n  };\n\nexport default class SceneDirection {\n  constructor(map) {\n    this.map = map;\n    this.routes = [];\n    this.routeMarkers = [];\n    this.routeLabels = [];\n    this.fullBbox = null;\n    this.mapFeaturesByRoute = {};\n\n    const iconsBaseUrl = nconf.get().system.baseUrl + 'statics/images/direction_icons';\n    this.addMapImage(`${iconsBaseUrl}/walking_bullet_active.png`, 'walking_bullet_active', {\n      pixelRatio: 4,\n    });\n    this.addMapImage(`${iconsBaseUrl}/walking_bullet_inactive.png`, 'walking_bullet_inactive', {\n      pixelRatio: 4,\n    });\n\n    listen('set_routes', ({ routes, vehicle, activeRouteId = 0 }) => {\n      this.reset();\n      this.routes = routes;\n      this.vehicle = vehicle;\n      this.displayRoutes(activeRouteId);\n    });\n\n    listen('set_main_route', ({ routeId, fitView }) => {\n      this.setMainRoute(routeId, fitView);\n    });\n\n    listen('clean_routes', () => {\n      this.reset();\n    });\n\n    listen('zoom_step', step => {\n      fire('fit_map', this.computeBBox(step));\n    });\n\n    listen('highlight_step', step => {\n      this.highlightStep(step);\n    });\n\n    listen('unhighlight_step', step => {\n      this.unhighlightStep(step);\n    });\n\n    listen('set_origin', poi => {\n      this.setOrigin(poi);\n    });\n\n    listen('set_destination', poi => {\n      this.setDestination(poi);\n    });\n  }\n\n  setOrigin = poi => {\n    const originMarker = createMarker(\n      poi.latLon,\n      cx('itinerary_marker_origin', poi.type === 'geoloc' && 'itinerary_marker_origin--geoloc'),\n      {\n        draggable: !isMobileDevice(),\n      }\n    )\n      .addTo(this.map)\n      .on('dragend', event => {\n        this.refreshDirection('origin', event.target.getLngLat());\n      });\n    this.routeMarkers.push(originMarker);\n  };\n\n  setDestination = poi => {\n    const destinationMarker = createMarker(poi.latLon, 'itinerary_marker_destination', {\n      draggable: !isMobileDevice(),\n      anchor: 'bottom',\n    })\n      .addTo(this.map)\n      .on('dragend', event => {\n        this.refreshDirection('destination', event.target.getLngLat());\n      });\n    this.routeMarkers.push(destinationMarker);\n  };\n\n  addMarkerSteps(route) {\n    if (this.vehicle !== 'walking' && this.vehicle !== 'publicTransport') {\n      getAllSteps(route).forEach((step, idx) => {\n        const stepMarker = createMarker(step.maneuver.location, 'itinerary_marker_step');\n        stepMarker.getElement().id = 'itinerary_marker_step_' + idx;\n        this.routeMarkers.push(stepMarker.addTo(this.map));\n      });\n    }\n\n    if (this.vehicle === 'publicTransport') {\n      getAllStops(route).forEach((stop, idx) => {\n        const stopMarker = createMarker(stop.location, 'itinerary_marker_step');\n        stopMarker.getElement().id = 'itinerary_marker_stop_' + idx;\n        stopMarker.getElement().title = stop.name;\n        this.routeMarkers.push(stopMarker.addTo(this.map));\n      });\n    }\n  }\n\n  setMainRoute(routeId, fitView) {\n    let mainRoute = null;\n    if (this.routes.length === 0) {\n      return;\n    }\n\n    this.routes.forEach(route => {\n      const isActive = route.id === routeId;\n      if (isActive) {\n        mainRoute = route;\n      }\n      this.mapFeaturesByRoute[route.id].forEach(({ layerId, outlineLayerId, vehicle }) => {\n        setActiveRouteStyle(this.map, layerId, vehicle, isActive, false);\n        if (outlineLayerId) {\n          setActiveRouteStyle(this.map, outlineLayerId, vehicle, isActive, true);\n        }\n        if (isActive) {\n          if (outlineLayerId) {\n            this.map.moveLayer(outlineLayerId, map.routes_layer);\n          }\n          this.map.moveLayer(layerId, map.routes_layer);\n        }\n      });\n    });\n    this.updateMarkers(mainRoute);\n    this.updateRouteLabels(mainRoute);\n    if (fitView && this.fullBbox) {\n      fire('fit_map', this.fullBbox);\n    }\n  }\n\n  updateMarkers(mainRoute) {\n    if (!mainRoute) {\n      return;\n    }\n\n    this.routeMarkers.forEach(marker => {\n      marker.remove();\n    });\n    this.routeMarkers = [];\n\n    this.addMarkerSteps(mainRoute);\n    const { origin, destination } = originDestinationCoords(mainRoute);\n\n    this.setOrigin({ latLon: { lng: origin[0], lat: origin[1] } });\n\n    this.setDestination({ latLon: { lng: destination[0], lat: destination[1] } });\n  }\n\n  displayRoutes(activeRouteId) {\n    if (this.routes && this.routes.length > 0) {\n      // route lines\n      this.mapFeaturesByRoute = {};\n      this.routes.forEach(route => {\n        this.mapFeaturesByRoute[route.id] = this.addRouteFeatures(\n          route,\n          route.id === activeRouteId\n        );\n      });\n      // route labels\n      const labelPositions = getLabelPositions(this.routes.map(route => route.geometry));\n      this.routeLabels = labelPositions.map(({ lngLat, anchor }, index) =>\n        createRouteLabel(this.routes[index], this.vehicle, { lngLat, anchor }).addTo(this.map)\n      );\n      // compute and store the best bbox\n      const routesBbox = new LngLatBounds();\n      this.routes.forEach(route => {\n        routesBbox.extend(this.computeBBox(route));\n      });\n      this.fullBbox = routesBbox.extend(getLabelsBbbox(labelPositions, routesBbox));\n\n      this.setMainRoute(activeRouteId, true);\n    }\n  }\n\n  updateRouteLabels({ id: activeRouteId }) {\n    // @IE11: array spread to convert NodeList to an array\n    [...document.querySelectorAll('.routeLabel')].forEach(routeLabel => {\n      if (routeLabel.dataset.id === activeRouteId.toString()) {\n        routeLabel.classList.add('active');\n      } else {\n        routeLabel.classList.remove('active');\n      }\n    });\n  }\n\n  refreshDirection(type, lngLat) {\n    const newPoint = new LatLonPoi(lngLat);\n    fire('change_direction_point', type, '', newPoint);\n  }\n\n  reset() {\n    this.routes.forEach(route => {\n      this.mapFeaturesByRoute[route.id].forEach(({ outlineLayerId, layerId, sourceId }) => {\n        if (outlineLayerId) {\n          this.map.removeLayer(outlineLayerId);\n        }\n        this.map.removeLayer(layerId);\n        this.map.removeSource(sourceId);\n      });\n    });\n    this.routes = [];\n\n    this.routeMarkers.concat(this.routeLabels).forEach(marker => {\n      marker.remove();\n    });\n    this.routeMarkers = [];\n    this.routeLabels = [];\n    this.fullBbox = null;\n  }\n\n  getDataSources(route) {\n    const featureCollection = normalizeToFeatureCollection(route.geometry);\n    const sources = [];\n    const walkFeatures = [],\n      nonWalkFeatures = [];\n    featureCollection.features.forEach(feature => {\n      if (\n        this.vehicle === 'walking' ||\n        (this.vehicle === 'publicTransport' && feature.properties.mode === 'WALK')\n      ) {\n        walkFeatures.push(feature);\n      } else {\n        nonWalkFeatures.push(prepareRouteColor(feature));\n      }\n    });\n\n    if (walkFeatures.length > 0) {\n      sources.push({\n        vehicle: 'walking',\n        data: { type: 'FeatureCollection', features: walkFeatures },\n      });\n    }\n\n    if (nonWalkFeatures.length > 0) {\n      sources.push({\n        vehicle: this.vehicle,\n        data: { type: 'FeatureCollection', features: nonWalkFeatures },\n      });\n    }\n\n    return sources;\n  }\n\n  addRouteFeatures(route, isActive) {\n    const sources = this.getDataSources(route);\n    return sources.map((source, idx) => {\n      const sourceId = `source_${route.id}_${idx}`;\n      this.map.addSource(sourceId, { type: 'geojson', data: source.data });\n\n      const layerId = `route_${route.id}_${idx}`;\n      const layerStyle = {\n        ...getRouteStyle(source.vehicle, isActive, false),\n        id: layerId,\n        source: sourceId,\n      };\n\n      let outlineLayerId;\n      if (source.vehicle !== 'walking') {\n        outlineLayerId = layerId + '_outline';\n        const outlineLayerStyle = {\n          ...getRouteStyle(source.vehicle, isActive, true),\n          id: layerId + '_outline',\n          source: sourceId,\n        };\n        this.map.addLayer(outlineLayerStyle, map.routes_layer);\n      }\n\n      this.map\n        .addLayer(layerStyle, map.routes_layer)\n        .on('click', layerId, () => {\n          fire('select_road_map', route.id);\n        })\n        .on('mouseenter', layerId, () => {\n          this.map.getCanvas().style.cursor = 'pointer';\n        })\n        .on('mouseleave', layerId, () => {\n          this.map.getCanvas().style.cursor = '';\n        });\n\n      return { sourceId, layerId, outlineLayerId, vehicle: source.vehicle };\n    });\n  }\n\n  computeBBox({ geometry }) {\n    const [minX, minY, maxX, maxY] = bbox(geometry);\n    return new LngLatBounds([minX, minY], [maxX, maxY]);\n  }\n\n  highlightStep(step) {\n    const marker = document.querySelector('#itinerary_marker_step_' + step);\n    if (marker) {\n      marker.classList.add('itinerary_marker_step--highlighted');\n    }\n  }\n\n  unhighlightStep(step) {\n    const marker = document.querySelector('#itinerary_marker_step_' + step);\n    if (marker) {\n      marker.classList.remove('itinerary_marker_step--highlighted');\n    }\n  }\n\n  addMapImage(url, name, options = {}) {\n    this.map.loadImage(url, (error, image) => {\n      if (error) {\n        Error.sendOnce('scene', 'initMapBox', `Failed to load image at ${url}`, error);\n        return;\n      }\n      this.map.addImage(name, image, options);\n    });\n  }\n}\n","import nconf from '@qwant/nconf-getter';\nimport { Marker } from 'mapbox-gl--ENV';\nimport constants from '../../config/constants.yml';\nimport Telemetry from 'src/libs/telemetry';\nimport { toUrl } from 'src/libs/pois';\nimport { fire, listen } from 'src/libs/customEvents';\nimport { poiToGeoJSON, emptyFeatureCollection } from 'src/libs/geojson';\nimport { FILTERED_POIS_PIN_STYLES, FILTERED_POIS_LABEL_STYLES } from 'src/adapters/pois_styles';\nimport { isMobileDevice } from 'src/libs/device';\nimport { createMapGLIcon, createPinIcon } from 'src/adapters/icon_manager';\nimport IconManager from 'src/adapters/icon_manager';\n\nconst mapStyleConfig = nconf.get().mapStyle;\n\nconst poisToGeoJSON = pois => {\n  return {\n    type: 'FeatureCollection',\n    features: pois.map(poi => {\n      const poiFeature = poiToGeoJSON(poi);\n      poiFeature.properties.iconName = IconManager.get(poi).iconClass;\n      return poiFeature;\n    }),\n  };\n};\n\nexport default class SceneCategory {\n  constructor(map) {\n    this.map = map;\n    this.sourceName = 'poi-filtered';\n    this.layers = [];\n\n    this.initActiveStateMarkers();\n    this.initDynamicPoiLayers();\n\n    listen('add_category_markers', this.addCategoryMarkers);\n    listen('remove_category_markers', this.removeCategoryMarkers);\n    listen('highlight_category_marker', this.highlightPoiMarker);\n    listen('click_category_marker', this.selectPoiMarker);\n    listen('click_category_poi', this.selectPoi);\n    listen('clean_marker', () => this.selectPoiMarker(null));\n  }\n\n  initActiveStateMarkers = () => {\n    this.hoveredPoi = null;\n    this.hoveredMarker = new Marker({\n      element: createPinIcon({ disablePointerEvents: true, className: 'marker--category' }),\n      anchor: 'bottom',\n    });\n    this.selectedPoi = null;\n    this.selectedMarker = new Marker({\n      element: createPinIcon({ className: 'marker--category' }),\n      anchor: 'bottom',\n    });\n  };\n\n  initDynamicPoiLayers = () => {\n    // Declare a new image in MapBox-GL rasters so it can be used in the layer style\n    createMapGLIcon('./statics/images/map/pin_map_dot.svg', 50, 60).then(imageData => {\n      this.map.addImage('pin_with_dot', imageData);\n    });\n\n    this.map.addSource(this.sourceName, {\n      type: 'geojson',\n      data: emptyFeatureCollection,\n      // tells MapBox-GL to use this property as internal feature identifier\n      promoteId: 'id',\n    });\n\n    if (mapStyleConfig.showNamesWithPins) {\n      const labelLayerId = `${this.sourceName}_labels`;\n      this.map.addLayer({\n        ...FILTERED_POIS_LABEL_STYLES,\n        source: this.sourceName,\n        id: labelLayerId,\n      });\n      this.layers.push(labelLayerId);\n    }\n\n    const pinLayerId = `${this.sourceName}_pins`;\n    this.map.addLayer({\n      ...FILTERED_POIS_PIN_STYLES,\n      source: this.sourceName,\n      id: pinLayerId,\n    });\n    this.layers.push(pinLayerId);\n\n    this.layers.forEach(layerName => {\n      this.map.on('click', layerName, this.handleLayerMarkerClick);\n      if (!isMobileDevice()) {\n        this.map.on('mouseover', layerName, this.handleLayerMarkerMouseOver);\n        this.map.on('mouseleave', layerName, this.handleLayerMarkerMouseLeave);\n      }\n    });\n  };\n\n  getPointedPoi = mapMouseEvent => {\n    const feature = mapMouseEvent.features[0];\n    return feature && this.pois.find(p => p.id === feature.id);\n  };\n\n  selectPoi = ({ poi, poiFilters, pois }) => {\n    if (poi.meta && poi.meta.source) {\n      Telemetry.sendPoiEvent(\n        poi,\n        'open',\n        Telemetry.buildInteractionData({\n          id: poi.id,\n          source: poi.meta.source,\n          template: 'multiple',\n          zone: 'list',\n          element: 'item',\n          category: poiFilters.category,\n        })\n      );\n    }\n    window.app.navigateTo(`/place/${toUrl(poi)}`, {\n      poi,\n      poiFilters,\n      pois,\n      centerMap: true,\n    });\n    this.selectPoiMarker(poi);\n  };\n\n  handleLayerMarkerClick = e => {\n    e.originalEvent.stopPropagation();\n    const poi = this.getPointedPoi(e);\n\n    this.selectPoi({\n      poi,\n      pois: this.pois,\n      poiFilters: this.poiFilters,\n    });\n  };\n\n  handleLayerMarkerMouseOver = e => {\n    this.map.getCanvas().style.cursor = 'pointer';\n    const poi = this.getPointedPoi(e);\n    if (this.selectedPoi?.id !== poi.id) {\n      this.highlightPoiMarker(poi, true);\n      fire('open_popup', poi, e.originalEvent);\n    }\n  };\n\n  handleLayerMarkerMouseLeave = () => {\n    this.map.getCanvas().style.cursor = '';\n    this.highlightPoiMarker(this.hoveredPoi, false);\n    // delay the popup closure so it can be hovered\n    fire('start_close_popup_timeout');\n  };\n\n  addCategoryMarkers = (pois = [], poiFilters) => {\n    fire('close_popup');\n    this.pois = pois;\n    this.poiFilters = poiFilters;\n    this.setOsmPoisVisibility(false);\n    this.map.getSource(this.sourceName).setData(poisToGeoJSON(pois));\n    this.layers.forEach(layerName => {\n      this.map.setLayoutProperty(layerName, 'visibility', 'visible');\n    });\n  };\n\n  removeCategoryMarkers = () => {\n    fire('close_popup');\n    this.selectPoiMarker(null);\n    this.highlightPoiMarker(this.hoveredPoi, false);\n    this.layers.forEach(layerName => {\n      this.map.setLayoutProperty(layerName, 'visibility', 'none');\n    });\n    this.setOsmPoisVisibility(true);\n  };\n\n  setOsmPoisVisibility = displayed => {\n    constants.map.pois_layers.map(poi => {\n      this.map.setLayoutProperty(poi, 'visibility', displayed ? 'visible' : 'none');\n    });\n  };\n\n  setPoiFeatureState = (id, state) => {\n    this.map.setFeatureState({ id, source: this.sourceName }, state);\n  };\n\n  highlightPoiMarker = (poi, highlight) => {\n    if (this.hoveredPoi) {\n      this.setPoiFeatureState(this.hoveredPoi.id, { hovered: false });\n    }\n    if (highlight) {\n      this.hoveredPoi = poi;\n      this.hoveredMarker.setLngLat(poi.latLon).addTo(this.map);\n      this.setPoiFeatureState(this.hoveredPoi.id, { hovered: true });\n    } else {\n      this.hoveredMarker.remove();\n      this.hoveredPoi = null;\n    }\n  };\n\n  selectPoiMarker = poi => {\n    if (this.selectedPoi === poi) {\n      return;\n    }\n    if (this.selectedPoi) {\n      this.setPoiFeatureState(this.selectedPoi.id, { selected: false });\n    }\n    if (poi) {\n      this.selectedPoi = poi;\n      this.selectedMarker.setLngLat(poi.latLon).addTo(this.map);\n      this.setPoiFeatureState(this.selectedPoi.id, { selected: true });\n    } else {\n      this.selectedMarker.remove();\n      this.selectedPoi = null;\n    }\n  };\n}\n","import { Map, Marker, LngLat, setRTLTextPlugin, LngLatBounds } from 'mapbox-gl--ENV';\nimport PoiPopup from './poi_popup';\nimport MobileCompassControl from '../mapbox/mobile_compass_control';\nimport ExtendedControl from '../mapbox/extended_nav_control';\nimport { map as mapConfig } from 'config/constants.yml';\nimport { getCurrentMapPaddings, isPositionUnderUI } from 'src/panel/layouts';\nimport nconf from '@qwant/nconf-getter';\nimport MapPoi from './poi/map_poi';\nimport { getLastLocation, setLastLocation } from 'src/adapters/store';\nimport getStyle from './scene_config';\nimport SceneDirection from './scene_direction';\nimport SceneCategory from './scene_category';\nimport { createDefaultPin } from '../adapters/icon_manager';\nimport LatLonPoi from './poi/latlon_poi';\nimport { isMobileDevice } from 'src/libs/device';\nimport { parseMapHash, getMapHash } from 'src/libs/url_utils';\nimport { parseBboxString } from 'src/libs/bounds';\nimport { toUrl, getBestZoom } from 'src/libs/pois';\nimport Error from 'src/adapters/error';\nimport { fire, listen } from 'src/libs/customEvents';\nimport locale from '../mapbox/locale';\nimport { setPoiHoverStyle } from 'src/adapters/pois_styles';\n\nconst baseUrl = nconf.get().system.baseUrl;\nconst LONG_TOUCH_DELAY_MS = 500;\nconst MOBILE_IDLE_DELAY_MS = 2000;\nlet MOBILE_IDLE_TIMEOUT;\n\nfunction Scene() {\n  this.currentMarker = null;\n  this.popup = new PoiPopup();\n  this.savedLocation = null;\n}\n\nconst getPoiView = poi => ({\n  center: poi.geometry.center,\n  zoom: getBestZoom(poi),\n  bounds: poi.geometry.bbox,\n});\n\nconst hideMobileScale = function () {\n  const item = document.querySelector('.map_control__scale');\n  if (item) {\n    item.classList.add('fadeOut');\n  }\n};\n\nconst showMobileScale = function () {\n  const item = document.querySelector('.map_control__scale');\n  if (item) {\n    item.classList.remove('fadeOut');\n  }\n};\n\nScene.prototype.getMapInitOptions = function ({ locationHash, bbox }) {\n  if (bbox) {\n    try {\n      return { bounds: parseBboxString(bbox) };\n    } catch (e) {\n      console.error(e);\n    }\n  }\n  if (window.hotLoadPoi) {\n    return getPoiView(window.hotLoadPoi);\n  }\n  if (locationHash) {\n    return {\n      zoom: locationHash.zoom,\n      center: [locationHash.lng, locationHash.lat],\n    };\n  }\n  const lastLocation = getLastLocation();\n  if (lastLocation) {\n    return {\n      zoom: lastLocation.zoom,\n      center: [lastLocation.lng, lastLocation.lat],\n    };\n  }\n  if (window.initialBbox) {\n    return {\n      bounds: window.initialBbox,\n      fitBoundsOptions: {\n        maxZoom: 9,\n      },\n    };\n  }\n  return {\n    zoom: mapConfig.zoom,\n    center: [mapConfig.center.lng, mapConfig.center.lat],\n  };\n};\n\nScene.prototype.initMapBox = function ({ locationHash, bbox }) {\n  window.times.initMapBox = Date.now();\n  const compilationHash = window.__config.compilationHash;\n  setRTLTextPlugin(\n    `${baseUrl}statics/build/javascript/map_plugins/mapbox-gl-rtl-text-${compilationHash}.js`,\n    error => {\n      if (error) {\n        Error.send('scene', 'setRTLTextPlugin', 'Failed to load mapbox RTL plugin', error);\n      }\n    },\n    /* lazy */ true\n  );\n\n  this.mb = new Map({\n    attributionControl: false,\n    container: 'scene_container',\n    style: getStyle(),\n    hash: false,\n    maxZoom: 20,\n    locale,\n    ...this.getMapInitOptions({ locationHash, bbox }),\n  });\n  // @MAPBOX: This method isn't implemented by the Mapbox-GL mock\n  this.mb.setPadding = this.mb.setPadding || (() => undefined);\n  this.mb.setPadding(getCurrentMapPaddings());\n\n  this.popup.init(this.mb);\n  window.map = this;\n\n  const interactiveLayers = [\n    'poi-level-1',\n    'poi-level-2',\n    'poi-level-3',\n    'poi-level-public-transports-1',\n    'poi-level-public-transports-2',\n  ];\n  this.hoveredPoi = null;\n\n  // Max time between two touch to be considered a single \"double click\" event\n  // This is the value Mapbox-GL uses, in src/ui/handler/dblclick_zoom.js\n  this.DOUBLE_TAP_DELAY_MS = 300;\n  this.lastDoubleTapTimeStamp = 0;\n  this.lastTouchEndTimeStamp = 0;\n  this.mb.on('touchend', () => {\n    const timeStamp = Date.now();\n    // maybe we should also check the distance between the two touch events…\n    if (timeStamp - this.lastTouchEndTimeStamp < this.DOUBLE_TAP_DELAY_MS) {\n      this.lastDoubleTapTimeStamp = timeStamp;\n    }\n    this.lastTouchEndTimeStamp = timeStamp;\n  });\n\n  this.mb.on('load', () => {\n    fire('restart_idle_timeout');\n    this.onHashChange();\n    new SceneDirection(this.mb);\n    new SceneCategory(this.mb);\n\n    this.mb.addControl(new ExtendedControl(), 'bottom-right');\n    this.mb.addControl(new MobileCompassControl(), 'top-right');\n\n    if (!isMobileDevice()) {\n      interactiveLayers.forEach(interactiveLayer => {\n        setPoiHoverStyle(this.mb, interactiveLayer);\n\n        this.mb.on('mouseenter', interactiveLayer, e => {\n          if (e.features.length > 0) {\n            this.hoveredPoi = e.features[0];\n            this.mb.setFeatureState(this.hoveredPoi, { hover: true });\n          }\n          this.mb.getCanvas().style.cursor = 'pointer';\n        });\n\n        this.mb.on('mouseleave', interactiveLayer, () => {\n          if (this.hoveredPoi) {\n            this.mb.setFeatureState(this.hoveredPoi, { hover: false });\n            this.hoveredPoi = null;\n          }\n          this.mb.getCanvas().style.cursor = '';\n        });\n\n        this.popup.addListener(interactiveLayer);\n      });\n    }\n\n    // we have to delay click event resolution to make time for possible double click events,\n    // which are thrown *after* two separate click events are thrown\n    this.clickDelayHandler = null;\n\n    this.mb.on('click', e => {\n      fire('restart_idle_timeout');\n      if (e.originalEvent.cancelBubble) {\n        return;\n      }\n      // cancel the previous click handler if it's still pending\n      clearTimeout(this.clickDelayHandler);\n      // if this is a real mouse double-click, we can simply return here\n      if (e.originalEvent.detail >= 2) {\n        return;\n      }\n      const pois = this.mb.queryRenderedFeatures(e.point, { layers: interactiveLayers });\n      // when clicking on a POI, just trigger the action without delay,\n      // as a subsequent double click isn't a problem\n      if (pois[0]) {\n        this.clickOnMap(e.lngLat, pois[0]);\n        return;\n      }\n      this.clickDelayHandler = setTimeout(() => {\n        // for touch UX we have to make sure a double tap zoom hasn't been made in the meantime\n        if (Date.now() - this.lastDoubleTapTimeStamp < this.DOUBLE_TAP_DELAY_MS) {\n          return;\n        }\n        this.clickOnMap(e.lngLat, null);\n      }, this.DOUBLE_TAP_DELAY_MS);\n    });\n\n    // Long touch polyfill (for mobile devices and touch screens)\n    // Custom implementation because the contextmenu event isn't supported by MapBox.\n    // Long touch is initiated on touchstart event, and canceled if a move, gesture or touchend occurs before 500ms.\n    // Sources:\n    // https://stackoverflow.com/a/1943768 (explanation of 500ms delay)\n    // https://stackoverflow.com/a/54746189 (polyfill implementation also using the 500ms delay)\n\n    let longTouchTimeout = null;\n    this.mb.on('touchstart', e => {\n      fire('restart_idle_timeout');\n      if (e.originalEvent.touches.length === 1) {\n        longTouchTimeout = setTimeout(() => {\n          this.clickOnMap(e.lngLat, null, { longTouch: true });\n          this.cancelClickAfterLongTouch = true;\n        }, LONG_TOUCH_DELAY_MS);\n      }\n    });\n\n    const longTouchCancellingEvents = [\n      'touchend',\n      // 'touchcancel', // ignore this event as it's always thrown by Firefox Android\n      // https://bugzilla.mozilla.org/show_bug.cgi?id=1481923\n      // Doesn't seem to change the behavior for other browsers\n      'touchmove',\n      'pointerdrag',\n      'pointermove',\n      'moveend',\n      'gesturestart',\n      'gesturechange',\n      'gestureend',\n    ];\n\n    const cancelLongTouch = e => {\n      if (longTouchTimeout) {\n        clearTimeout(longTouchTimeout);\n        longTouchTimeout = null;\n      }\n\n      if (this.cancelClickAfterLongTouch) {\n        e.originalEvent.preventDefault();\n        this.cancelClickAfterLongTouch = false;\n      }\n    };\n\n    longTouchCancellingEvents.forEach(event => {\n      this.mb.on(event, cancelLongTouch);\n    });\n\n    this.mb.on('dragstart', () => {\n      fire('map_user_interaction');\n    });\n    this.mb.on('pitchstart', () => {\n      fire('map_user_interaction');\n    });\n\n    this.mb.on('moveend', () => {\n      const { lng, lat } = this.mb.getCenter();\n      const zoom = this.mb.getZoom();\n      setLastLocation({ lng, lat, zoom });\n      window.app.updateHash(this.getLocationHash());\n      fire('map_moveend');\n    });\n\n    window.execOnMapLoaded = f => f();\n    fire('map_loaded');\n  });\n\n  listen('fit_map', (item, forceAnimate) => {\n    this.fitMap(item, forceAnimate);\n  });\n\n  listen('ensure_poi_visible', (poi, options) => {\n    this.ensureMarkerIsVisible(poi, options);\n  });\n\n  listen('create_poi_marker', poi => {\n    this.addMarker(poi);\n  });\n\n  listen('clean_marker', () => {\n    this.cleanMarker();\n  });\n\n  listen('save_location', () => {\n    this.saveLocation();\n  });\n\n  listen('restore_location', () => {\n    this.restoreLocation();\n  });\n\n  listen('move_mobile_bottom_ui', bottom => {\n    this.moveMobileBottomUI(bottom);\n  });\n\n  listen('move_mobile_geolocation_button', bottom => {\n    this.moveMobileGeolocationButton(bottom);\n  });\n\n  listen('mobile_geolocation_button_visibility', visible => {\n    this.mobileButtonVisibility('.mapboxgl-ctrl-geolocate', visible);\n  });\n\n  listen('mobile_direction_button_visibility', visible => {\n    this.mobileButtonVisibility('.direction_shortcut', visible);\n  });\n\n  listen('update_map_paddings', () => {\n    this.mb.setPadding(getCurrentMapPaddings());\n  });\n};\n\nScene.prototype.clickOnMap = function (lngLat, clickedFeature, { longTouch = false } = {}) {\n  // Instantiate the place clicked as a PoI\n  const poi = clickedFeature ? new MapPoi(clickedFeature) : new LatLonPoi(lngLat);\n\n  if (document.querySelector('.directions-open')) {\n    // If Direction panel is open, tell it to fill its fields with this PoI\n    fire('set_direction_point', poi);\n  } else if (isMobileDevice() && !clickedFeature && !longTouch) {\n    // On mobile, simple clicks anywhere don't do anything\n    return;\n  } else {\n    // Default case: open the POI panel\n    window.app.navigateTo(`/place/${toUrl(poi)}`, { poi });\n  }\n};\n\nScene.prototype.saveLocation = function () {\n  this.savedLocation = this.getLocationHash();\n};\n\nScene.prototype.restoreLocation = function () {\n  if (this.savedLocation) {\n    const { zoom, lat, lng } = parseMapHash(this.savedLocation);\n    const flyOptions = {\n      center: [lng, lat],\n      zoom,\n      animate: true,\n      screenSpeed: 2,\n    };\n    this.mb.flyTo(flyOptions);\n  }\n};\n\nconst clamp = (min, max, value) => Math.min(max, Math.max(min, value));\n\nScene.prototype.isBBoxInExtendedViewport = function (bbox) {\n  const viewport = this.mb.getBounds();\n\n  const width = viewport.getEast() - viewport.getWest();\n  const height = viewport.getNorth() - viewport.getSouth();\n\n  // Compute extended viewport, with lats between -85 and 85\n  viewport.setNorthEast(\n    new LngLat(viewport.getEast() + width, clamp(-85, 85, viewport.getNorth() + height)).wrap()\n  );\n  viewport.setSouthWest(\n    new LngLat(viewport.getWest() - width, clamp(-85, 85, viewport.getSouth() - height)).wrap()\n  );\n\n  // Check if the bbox overlaps the viewport\n  return (\n    viewport.contains(bbox.getNorthWest()) ||\n    viewport.contains(bbox.getNorthEast()) ||\n    viewport.contains(bbox.getSouthEast()) ||\n    viewport.contains(bbox.getSouthWest())\n  );\n};\n\nScene.prototype.fitBbox = function (bbox, forceAnimate) {\n  // normalise bbox\n  if (bbox instanceof Array) {\n    bbox = new LngLatBounds(bbox);\n  }\n\n  // Animate if the zoom is big enough and if the BBox is (partially or fully) in\n  // the extended viewport.\n  const animate = forceAnimate || (this.mb.getZoom() > 10 && this.isBBoxInExtendedViewport(bbox));\n  this.mb.fitBounds(bbox, { animate });\n};\n\n// Move the map to focus on an item\nScene.prototype.fitMap = function (item, forceAnimate) {\n  // BBox\n  if (item instanceof LngLatBounds || Array.isArray(item)) {\n    this.fitBbox(item, forceAnimate);\n  } else {\n    // PoI\n    if (item.bbox) {\n      // poi Bbox\n      this.fitBbox(item.bbox, forceAnimate);\n    } else {\n      // poi center\n      const flyOptions = {\n        center: item.latLon,\n        zoom: getBestZoom(item),\n        screenSpeed: 1.5,\n        animate: false,\n      };\n\n      if (forceAnimate || (this.mb.getZoom() > 10 && this.isWindowedPoi(item))) {\n        flyOptions.animate = true;\n      }\n      this.mb.flyTo(flyOptions);\n    }\n  }\n};\n\nScene.prototype.ensureMarkerIsVisible = function (poi, options) {\n  if (poi.bbox) {\n    this.fitBbox(poi.bbox);\n    return;\n  }\n  const isMobile = isMobileDevice();\n  if (!options.centerMap) {\n    const isPoiUnderPanel = isPositionUnderUI(this.mb.project(poi.latLon), { isMobile });\n    if (this.isWindowedPoi(poi) && !isPoiUnderPanel) {\n      return;\n    }\n  }\n  this.mb.flyTo({\n    center: poi.latLon,\n    zoom: getBestZoom(poi),\n    maxDuration: 1200,\n  });\n};\n\nScene.prototype.addMarker = function (poi) {\n  const element = createDefaultPin();\n  element.onclick = function (e) {\n    // click event should not be propagated to the map itself;\n    e.stopPropagation();\n  };\n\n  if (this.currentMarker !== null) {\n    this.currentMarker.remove();\n  }\n\n  const marker = new Marker({ element, anchor: 'bottom', offset: [0, -5] })\n    .setLngLat(poi.latLon)\n    .addTo(this.mb);\n  this.currentMarker = marker;\n  return marker;\n};\n\nScene.prototype.cleanMarker = async function () {\n  if (this.currentMarker !== null) {\n    this.currentMarker.remove();\n    this.currentMarker = null;\n  }\n};\n\nScene.prototype.isWindowedPoi = function (poi) {\n  return this.mb.getBounds().contains(new LngLat(poi.latLon.lng, poi.latLon.lat));\n};\n\nScene.prototype.getLocationHash = function () {\n  const { lat, lng } = this.mb.getCenter();\n  return getMapHash(this.mb.getZoom(), lat, lng);\n};\n\nScene.prototype.restoreFromHash = function (hash, options = {}) {\n  const zll = parseMapHash(hash);\n  if (!zll) {\n    return;\n  }\n  const { zoom, lat, lng } = zll;\n  this.mb.flyTo({ zoom, center: [lng, lat], ...options });\n};\n\nScene.prototype.onHashChange = function () {\n  window.onhashchange = () => {\n    this.restoreFromHash(window.location.hash, { animate: false });\n  };\n};\n\nScene.prototype.translateUIControl = function (selector, bottom) {\n  const item = document.querySelector(selector);\n  if (item) {\n    item.style.transform = `translateY(${-bottom}px)`;\n  }\n};\n\nScene.prototype.moveMobileBottomUI = function (bottom = 0) {\n  if (!isMobileDevice() && bottom > 0) {\n    return;\n  }\n  const uiControls = [\n    '.map_control__scale_attribute_container',\n    '.mapboxgl-ctrl-geolocate',\n    '.direction_shortcut',\n  ];\n  uiControls.forEach(uiControl => {\n    this.translateUIControl(uiControl, bottom);\n  });\n};\n\nScene.prototype.moveMobileGeolocationButton = function (bottom = 0) {\n  if (!isMobileDevice() && bottom > 0) {\n    return;\n  }\n  this.translateUIControl('.mapboxgl-ctrl-geolocate', bottom);\n};\n\nScene.prototype.mobileButtonVisibility = function (selector, visible) {\n  if (!isMobileDevice()) {\n    return;\n  }\n  const item = document.querySelector(selector);\n  if (item) {\n    if (visible) {\n      item.classList.remove('hidden');\n    } else {\n      item.classList.add('hidden');\n    }\n  }\n};\n\nlisten('restart_idle_timeout', () => {\n  // Cancel idle status\n  showMobileScale();\n  clearTimeout(MOBILE_IDLE_TIMEOUT);\n\n  // Start a new 2s idle timeout\n  MOBILE_IDLE_TIMEOUT = setTimeout(() => {\n    hideMobileScale();\n  }, MOBILE_IDLE_DELAY_MS);\n});\n\nexport default Scene;\n"],"sourceRoot":""}